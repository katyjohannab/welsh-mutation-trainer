<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welsh Vocab Trainer</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css" />

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BBH+Bogle&family=BBH+Hegarty&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Slab:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    /* Small page-specific bits only; keep the rest in styles.css */
    .mini-label { font-size: 12px; letter-spacing: .08em; text-transform: uppercase; }
    .info-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.15);
      background: rgba(255,255,255,.85);
      display: grid;
      place-items: center;
      font-weight: 700;
      cursor: pointer;
    }
    .info-pop {
      position: absolute;
      right: 6px;
      top: 40px;
      width: min(360px, calc(100vw - 32px));
      background: white;
      border: 1px solid rgba(0,0,0,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 12px 12px 10px;
      z-index: 50;
    }
    .info-pop .close {
      position: absolute;
      right: 10px;
      top: 8px;
      font-size: 18px;
      line-height: 1;
      opacity: .7;
      cursor: pointer;
      border: none;
      background: transparent;
    }
    .seg { display: inline-flex; border: 1px solid rgba(0,0,0,.12); border-radius: attachments; border-radius: 999px; overflow: hidden; }
    .seg-btn { padding: 6px 10px; font-size: 12px; letter-spacing: .08em; text-transform: uppercase; }
    .seg-btn.is-on { background: rgba(15,23,42,.08); font-weight: 700; }
  </style>
</head>

<body class="min-h-screen text-slate-900">
  <div id="app" class="min-h-screen flex flex-col text-[16px] md:text-[17px]">

    <header id="siteHeader" class="sticky top-0 z-10">
      <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between md:gap-4">
        <div class="brand-lockup grow min-w-0">
          <img class="brand-dragon" alt="" aria-hidden="true" src="https://katyjohannab.github.io/welsh-mutation-trainer/images/dragon.png" />
          <h1 class="bbh-bogle-regular brand-title text-3xl md:text-4xl lg:text-5xl tracking-tight">
            <span class="title-hy">Hyffordwr</span><span class="title-trei">Cymraeg</span>
          </h1>
        </div>

        <div class="flex flex-wrap items-center justify-start md:justify-end gap-2 md:gap-3">
          <span id="itemCount" class="hidden text-xs text-slate-500"></span>

          <!-- Primary nav -->
          <div class="flex flex-wrap items-center gap-2">
            <a class="btn btn-ghost" href="./home.html" title="Home">Home</a>
            <a class="btn btn-ghost" href="./learn.html" title="Learn">Learn</a>
            <a class="btn btn-ghost" href="./index.html" title="Mutation practice">Mutations</a>
            <button id="btnPractice" class="btn btn-primary" title="Vocab practice">Vocab</button>
          </div>

          <div class="hidden md:block h-6 w-px bg-slate-200/80"></div>

          <div class="flex flex-wrap items-center gap-2">
            <button id="btnStats" class="btn btn-ghost" title="Stats">Stats</button>
            <button id="btnFilters" class="btn btn-ghost" title="Filters">Filters</button>
            <button id="btnBrowse" class="btn btn-ghost" title="Browse">Browse</button>
            <button id="btnHelp" class="btn btn-ghost" title="Help">Help</button>
          </div>

          <div class="hidden md:block h-6 w-px bg-slate-200/80"></div>

          <button id="btnLangToggle" class="btn-lang" aria-label="Switch language" title="Switch language"></button>
        </div>
      </div>
      <div class="cymru-red-bar" aria-hidden="true"></div>
    </header>

    <!-- Onboarding -->
    <section id="onboard" class="max-w-6xl mx-auto p-4 mt-3">
      <div class="panel rounded-2xl p-4 flex items-start gap-3">
        <div class="text-2xl">üí°</div>
        <div class="text-sm text-slate-700">
          <div class="font-medium mb-1">Welcome! How to use this vocab trainer.</div>
          <ol class="list-decimal ml-5 leading-relaxed">
            <li>Use <b>Filters</b> to choose a course/unit, word type, or search by tags.</li>
            <li>You‚Äôll see an <b>English base word</b>. Type the correct <b>Welsh</b> form into the sentence.</li>
            <li>Use the <b>?</b> on the English word for a <b>hint</b>. Use the <b>?</b> on the sentence line for <b>sentence help</b>.</li>
            <li>Press <b>Check</b>, read the explanation, then <b>Next</b>.</li>
          </ol>
          <div class="mt-3 flex gap-2">
            <button id="onboardFilters" class="btn btn-primary shadow">Open filters</button>
            <button id="onboardDismiss" class="btn btn-ghost">Got it</button>
          </div>
        </div>
      </div>
    </section>

    <main id="main" class="grow max-w-6xl mx-auto p-4 pb-24 md:pb-4">
      <div id="practiceView" class="grid md:grid-cols-3 gap-4 items-start">
        <div class="md:col-span-2 panel rounded-2xl p-6 md:p-7">
          <div id="practiceCard"></div>
        </div>

        <div class="md:col-span-1 flex flex-col gap-4">
          <!-- Filters -->
          <div id="filtersPanel" class="panel rounded-2xl p-4 hidden">
            <div class="text-sm font-medium mb-2">Filters</div>

            <div class="grid grid-cols-1 gap-3 text-sm">
              <div>
                <div class="mini-label text-slate-500 mb-1">Course</div>
                <select id="courseSelect" class="w-full border rounded-xl px-3 py-2 bg-white"></select>
              </div>

              <div>
                <div class="mini-label text-slate-500 mb-1">Unit</div>
                <select id="unitSelect" class="w-full border rounded-xl px-3 py-2 bg-white"></select>
              </div>

              <div>
                <div class="mini-label text-slate-500 mb-1">Word category</div>
                <div id="wordCatBtns" class="flex flex-wrap gap-1"></div>
              </div>

              <div>
                <div class="mini-label text-slate-500 mb-1">Search tags / English</div>
                <input id="tagQuery" class="w-full border rounded-xl px-3 py-2" placeholder="e.g. food, travel, rights, work" />
              </div>

              <div class="flex gap-2">
                <button id="btnClearFilters" class="btn btn-ghost px-3 py-2">Clear</button>
              </div>
            </div>
          </div>

          <!-- Session / stats -->
          <aside id="sessionPanel" class="panel rounded-2xl p-4">
            <div class="text-sm font-medium mb-2">Session</div>
            <div id="accBig" class="text-5xl md:text-6xl font-semibold">0%</div>
            <div id="accText" class="text-sm text-slate-600">0 / 0 correct</div>
            <div id="cardPos" class="text-sm text-slate-600">Card 0 / 0</div>

            <div class="mt-3 text-sm">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">By course</div>
              <ul id="byCourse" class="space-y-1"></ul>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="btnResetStats" class="btn btn-ghost px-3 py-1.5">Reset stats</button>
            </div>
          </aside>
        </div>
      </div>

      <div id="browseView" class="hidden panel rounded-2xl overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr id="browseHead"></tr>
          </thead>
          <tbody id="browseBody"></tbody>
        </table>
      </div>

      <div id="statsView" class="hidden grid md:grid-cols-2 gap-4">
        <div class="panel rounded-2xl p-6">
          <h2 class="text-lg font-medium mb-2">Accuracy</h2>
          <div id="statsAcc" class="text-5xl font-bold">0%</div>
          <div id="statsText" class="text-slate-600">0 correct out of 0</div>
          <button id="btnResetStats2" class="mt-4 btn btn-ghost px-3 py-1.5">Reset</button>
        </div>
        <div class="panel rounded-2xl p-6">
          <h2 class="text-lg font-medium mb-2">By course</h2>
          <ul id="statsByCourse" class="space-y-1 text-sm"></ul>
        </div>
      </div>
    </main>

    <!-- Mobile action bar -->
    <div id="mobileBar" class="fixed md:hidden bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t shadow-lg p-2">
      <div class="max-w-6xl mx-auto flex gap-2">
        <button id="mbHint" class="flex-1 btn btn-ghost px-3 py-2">Hint</button>
        <button id="mbCheck" class="flex-1 btn btn-primary px-3 py-2">Check</button>
        <button id="mbNext" class="flex-1 btn btn-ghost px-3 py-2">Next</button>
      </div>
    </div>

    <footer class="max-w-6xl mx-auto p-6 text-xs text-slate-500">
      <div class="flex flex-wrap gap-4 items-center">
        <span>¬© Hyffordwr Cymraeg</span>
        <button id="btnTop" class="ml-auto btn btn-ghost px-2 py-1">Back to top</button>
      </div>
    </footer>
  </div>

<script>
/* ========= Utilities ========= */
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

function normalize(s) {
  return (s || "")
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")   // strip diacritics (d≈µr == dwr)
    .replace(/‚Äô/g, "'")
    .toLowerCase()
    .trim()
    .replace(/\s+/g, " ");
}
function esc(s) {
  return (s == null ? "" : String(s)).replace(/[&<>"]/g, ch => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;"
  }[ch]));
}
function getParam(k) { return new URLSearchParams(location.search).get(k); }
function saveLS(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) {} }
function loadLS(k, d) { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : d; } catch (e) { return d; } }

/* ========= App state ========= */
const PRACTICE_MODE_LS_KEY = "wv_practice_mode_v1";
const state = {
  rows: [],
  filtered: [],
  deck: [],
  p: 0,
  guess: "",
  revealed: false,
  lastResult: null,

  mode: loadLS("wv_mode", "practice"),
  lang: loadLS("wv_lang", "en"),
  practiceMode: loadLS(PRACTICE_MODE_LS_KEY, "shuffle"),

  // Filters
  course: loadLS("wv_course", "ALL"),
  unit: loadLS("wv_unit", "ALL"),
  wordCats: loadLS("wv_wordcats", []), // empty == all
  tagQuery: loadLS("wv_tagq", ""),

  // Stats
  history: loadLS("wv_hist", []), // {t, ok, cardId, course, unit, baseEN, expected, got}
};

/* ========= Data loading (vocab index list) ========= */
const FALLBACK_INDEX_URL = "https://katyjohannab.github.io/welsh-mutation-trainer/data/vocab/index.json";
const FALLBACK_SITE_ROOT = "https://katyjohannab.github.io/welsh-mutation-trainer/";

async function loadCsvUrl(u) {
  return new Promise((resolve, reject) => {
    Papa.parse(u, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res) => resolve(res.data),
      error: reject
    });
  });
}
function isAbsUrl(u) { return /^https?:\/\//i.test(u || ""); }
function resolveFromRoot(path, root) {
  const p = (path || "").toString().trim();
  if (!p) return "";
  if (isAbsUrl(p)) return p;
  return new URL(p.replace(/^\/+/, ""), root).toString();
}
async function fetchIndexList(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("Failed to fetch index: " + url);
  const j = await r.json();
  if (!Array.isArray(j)) throw new Error("Index JSON is not an array: " + url);
  return j;
}
async function loadAllDefault() {
  let list = null;
  let usingFallbackRoot = false;

  try {
    list = await fetchIndexList("data/vocab/index.json");
  } catch (e) {
    list = await fetchIndexList(FALLBACK_INDEX_URL);
    usingFallbackRoot = true;
  }

  const root = usingFallbackRoot ? FALLBACK_SITE_ROOT : new URL(".", location.href).toString();
  let merged = [];
  for (const p of list) {
    const url = resolveFromRoot(p, root);
    if (!url) continue;
    const d = await loadCsvUrl(url);
    merged = merged.concat(d);
  }
  return merged;
}

/* ========= Row coercion (YOUR vocab schema) ========= */
function getVal(row, names) {
  const keys = Object.keys(row || {});
  for (const key of keys) {
    const k = key.trim().toLowerCase();
    if (names.some(n => k === n.trim().toLowerCase())) {
      return (row[key] ?? "").toString().trim();
    }
  }
  return "";
}
function coerceRow(row, idxFallback) {
  const r = row || {};
  const cardId = getVal(r, ["CardID","CardId","Card ID","ID","Id","id"]) || `row_${idxFallback}`;

  return {
    CardID: cardId,
    Course: getVal(r, ["Course"]),
    Unit: getVal(r, ["Unit"]),
    WordCategory: getVal(r, ["WordCategory","Word Category","POS"]),
    BaseEN: getVal(r, ["BaseEN","Base EN","English","Base"]),
    HintEN: getVal(r, ["HintEN","Hint EN"]),
    HintCY: getVal(r, ["HintCY","Hint CY","HintCY (Welsh)"]),
    BeforeCY: getVal(r, ["BeforeCY","Before CY","Before"]),
    AfterCY: getVal(r, ["AfterCY","After CY","After"]),
    SentenceHelpEN: getVal(r, ["SentenceHelpEN","Sentence Help EN","SentenceHelp","Sentence Help"]),
    AnswerCY: getVal(r, ["AnswerCY","Answer CY","Answer"]),
    AnswerArray: getVal(r, ["AnswerArray","Answer Array","Accepted","AcceptedAnswers"]),
    WhyEN: getVal(r, ["WhyEN","Why EN","Why"]),
    WhyCY: getVal(r, ["WhyCY","Why CY"]),
    Tags: getVal(r, ["Tags","Tag"])
  };
}

async function initData() {
  const sheet = getParam("sheet"); // optional override
  const raw = sheet ? await loadCsvUrl(sheet) : await loadAllDefault();

  state.rows = raw.map((r, i) => coerceRow(r, i)).filter(r => r.BaseEN && (r.AnswerCY || r.AnswerArray));
  $("#itemCount")?.classList.remove("hidden");
  $("#itemCount").textContent = `${state.rows.length} items`;

  applyFilters();
  rebuildDeck();
  buildFilters();
  render();
}

/* ========= Filters ========= */
function toggleBtn(text, active, onToggle) {
  const b = document.createElement("button");
  b.type = "button";
  b.className = `pill ${active ? "pill-on" : ""}`;
  b.textContent = text;
  b.onclick = () => onToggle(!active);
  return b;
}

function buildFilters() {
  // Course dropdown
  const courses = Array.from(new Set(state.rows.map(r => r.Course).filter(Boolean))).sort();
  const courseSel = $("#courseSelect");
  if (courseSel) {
    courseSel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "All courses";
    courseSel.appendChild(optAll);

    for (const c of courses) {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      courseSel.appendChild(o);
    }
    courseSel.value = state.course || "ALL";
    courseSel.onchange = (e) => {
      state.course = e.target.value || "ALL";
      saveLS("wv_course", state.course);
      // Reset unit when course changes (to avoid empty result traps)
      state.unit = "ALL";
      saveLS("wv_unit", state.unit);
      applyFilters(); rebuildDeck(); buildFilters(); render();
    };
  }

  // Unit dropdown (dependent on course)
  const unitSel = $("#unitSelect");
  if (unitSel) {
    unitSel.innerHTML = "";
    const optAllU = document.createElement("option");
    optAllU.value = "ALL";
    optAllU.textContent = "All units";
    unitSel.appendChild(optAllU);

    const unitPool = state.rows
      .filter(r => (state.course === "ALL" ? true : r.Course === state.course))
      .map(r => r.Unit)
      .filter(Boolean);
    const units = Array.from(new Set(unitPool)).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));

    for (const u of units) {
      const o = document.createElement("option");
      o.value = u;
      o.textContent = u;
      unitSel.appendChild(o);
    }
    unitSel.value = state.unit || "ALL";
    unitSel.onchange = (e) => {
      state.unit = e.target.value || "ALL";
      saveLS("wv_unit", state.unit);
      applyFilters(); rebuildDeck(); render();
    };
  }

  // WordCategory pills
  const cats = Array.from(new Set(state.rows.map(r => r.WordCategory).filter(Boolean))).sort();
  const host = $("#wordCatBtns");
  if (host) {
    host.innerHTML = "";
    const allOn = !state.wordCats.length;
    host.appendChild(toggleBtn("All", allOn, () => {
      state.wordCats = [];
      saveLS("wv_wordcats", state.wordCats);
      applyFilters(); rebuildDeck(); buildFilters(); render();
    }));
    for (const c of cats) {
      const active = state.wordCats.includes(c);
      host.appendChild(toggleBtn(c, active, (on) => {
        state.wordCats = on ? Array.from(new Set([...state.wordCats, c])) : state.wordCats.filter(x => x !== c);
        saveLS("wv_wordcats", state.wordCats);
        applyFilters(); rebuildDeck(); render();
      }));
    }
  }

  // Tag query
  const q = $("#tagQuery");
  if (q) {
    q.value = state.tagQuery || "";
    q.oninput = (e) => {
      state.tagQuery = e.target.value || "";
      saveLS("wv_tagq", state.tagQuery);
      applyFilters(); rebuildDeck(); render();
    };
  }

  $("#btnClearFilters")?.addEventListener("click", () => {
    state.course = "ALL";
    state.unit = "ALL";
    state.wordCats = [];
    state.tagQuery = "";
    saveLS("wv_course", state.course);
    saveLS("wv_unit", state.unit);
    saveLS("wv_wordcats", state.wordCats);
    saveLS("wv_tagq", state.tagQuery);
    applyFilters(); rebuildDeck(); buildFilters(); render();
  });
}

function applyFilters() {
  const q = normalize(state.tagQuery || "");
  state.filtered = state.rows.filter(r => {
    if (state.course !== "ALL" && r.Course !== state.course) return false;
    if (state.unit !== "ALL" && r.Unit !== state.unit) return false;
    if (state.wordCats.length && !state.wordCats.includes(r.WordCategory)) return false;

    if (q) {
      const hay = normalize([r.Tags, r.BaseEN, r.SentenceHelpEN, r.BeforeCY, r.AfterCY].filter(Boolean).join(" "));
      if (!hay.includes(q)) return false;
    }
    return true;
  });
}

function rebuildDeck() {
  const n = state.filtered.length;
  state.deck = Array.from({length:n}, (_,i)=>i);
  for (let i = state.deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [state.deck[i], state.deck[j]] = [state.deck[j], state.deck[i]];
  }
  state.p = 0;
  state.guess = "";
  state.revealed = false;
  state.lastResult = null;
}

/* ========= Answer checking ========= */
function acceptedAnswers(card) {
  const raw = (card.AnswerArray || "").trim();
  const list = raw ? raw.split("|").map(s => s.trim()).filter(Boolean) : [];
  const fallback = (card.AnswerCY || "").trim();
  if (fallback && !list.length) list.push(fallback);
  if (fallback && list.length && !list.includes(fallback)) list.push(fallback);
  // normalise duplicates
  const uniq = [];
  const seen = new Set();
  for (const a of list) {
    const k = normalize(a);
    if (!k || seen.has(k)) continue;
    seen.add(k);
    uniq.push(a);
  }
  return uniq;
}
function isCorrect(guess, card) {
  const g = normalize(guess);
  if (!g) return false;
  return acceptedAnswers(card).some(a => normalize(a) === g);
}

/* ========= Popovers ========= */
function mountPopover(anchorEl, kindLabel, bodyText) {
  if (!anchorEl) return;
  if (!bodyText) return;

  anchorEl.style.position = "relative";

  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "info-btn";
  btn.textContent = "?";
  btn.title = kindLabel;

  const pop = document.createElement("div");
  pop.className = "info-pop hidden";
  pop.innerHTML = `
    <button class="close" aria-label="Close" type="button">√ó</button>
    <div class="text-sm text-slate-700 pr-6">
      <div class="font-semibold mb-1">${esc(kindLabel)}</div>
      <div class="leading-relaxed whitespace-pre-wrap">${esc(bodyText)}</div>
    </div>
  `;

  const close = $(".close", pop);
  const hide = () => pop.classList.add("hidden");

  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    $$(".info-pop").forEach(p => p.classList.add("hidden"));
    pop.classList.toggle("hidden");
  });
  close.addEventListener("click", (e) => { e.stopPropagation(); hide(); });
  pop.addEventListener("click", (e) => e.stopPropagation());

  anchorEl.appendChild(btn);
  anchorEl.appendChild(pop);
}

document.addEventListener("click", () => $$(".info-pop").forEach(p => p.classList.add("hidden")));
document.addEventListener("keydown", (e) => { if (e.key === "Escape") $$(".info-pop").forEach(p => p.classList.add("hidden")); });

/* ========= Render ========= */
function renderPractice() {
  const host = $("#practiceCard");
  if (!host) return;
  host.innerHTML = "";

  const n = state.filtered.length;
  if (!n) {
    host.innerHTML = `
      <div class="text-slate-700 panel rounded-xl p-4">
        No cards match your filters.
        <button id="btnOpenFilters" class="ml-2 btn btn-primary px-3 py-1.5">Open filters</button>
        <button id="btnResetAll" class="ml-2 btn btn-ghost px-3 py-1.5">Clear</button>
      </div>`;
    $("#btnOpenFilters")?.addEventListener("click", () => $("#filtersPanel")?.classList.remove("hidden"));
    $("#btnResetAll")?.addEventListener("click", () => $("#btnClearFilters")?.click());
    $("#cardPos") && ($("#cardPos").textContent = "Card 0 / 0");
    return;
  }

  const deckIdx = state.p % state.deck.length;
  const idxNow = state.deck[deckIdx];
  const card = state.filtered[idxNow];

  $("#cardPos") && ($("#cardPos").textContent = `Card ${deckIdx + 1} / ${state.deck.length}`);

  const wrap = document.createElement("div");

  // English prompt (BaseEN)
  const prompt = document.createElement("div");
  prompt.className = "mb-4";

  const baseBox = document.createElement("div");
  baseBox.className = "inline-flex items-baseline bg-indigo-100 ring-1 ring-indigo-300 rounded-2xl px-5 py-3 shadow-sm";
  baseBox.style.position = "relative";

  const base = document.createElement("div");
  base.className = "text-3xl md:text-4xl font-bold tracking-tight text-indigo-900";
  base.textContent = card.BaseEN || "‚Äî";

  baseBox.appendChild(base);

  const hintText = (state.lang === "cy" ? (card.HintCY || card.HintEN) : (card.HintEN || card.HintCY)) || "";
  mountPopover(baseBox, "Hint", hintText);

  const meta = document.createElement("div");
  meta.className = "mt-2 flex flex-wrap gap-2 text-xs text-slate-600";
  const chip = (t) => {
    const s = document.createElement("span");
    s.className = "chip";
    s.textContent = t;
    return s;
  };
  if (card.Course) meta.appendChild(chip(card.Course));
  if (card.Unit) meta.appendChild(chip(`Unit ${card.Unit}`));
  if (card.WordCategory) meta.appendChild(chip(card.WordCategory));

  prompt.appendChild(baseBox);
  prompt.appendChild(meta);

  // Welsh sentence line with input
  const sentenceWrap = document.createElement("div");
  sentenceWrap.className = "practice-sentence";
  sentenceWrap.style.position = "relative";

  sentenceWrap.innerHTML = `
    <div class="practice-sentenceLine flex flex-wrap items-baseline gap-2 text-xl md:text-2xl">
      <span class="text-slate-700">${esc(card.BeforeCY || "")}</span>
      <input id="answerBox"
             class="border-2 border-slate-300 focus:border-cyan-600 outline-none bg-amber-50 px-3 py-2 rounded-xl text-2xl md:text-3xl leading-tight shadow-sm w-auto md:w-64 flex-shrink-0"
             placeholder="Type Welsh"
             aria-label="Answer" />
      <span class="text-slate-700">${esc(card.AfterCY || "")}</span>
    </div>
  `;

  mountPopover(sentenceWrap, "Sentence help", card.SentenceHelpEN || "");

  // Actions
  const actions = document.createElement("div");
  actions.className = "practice-actions flex flex-wrap gap-3 mt-4";

  const btn = (txt, cls, fn) => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = `btn ${cls}`.trim();
    b.textContent = txt;
    b.onclick = fn;
    return b;
  };

  const onCheck = () => {
    const ok = isCorrect(state.guess, card);
    state.revealed = true;
    state.lastResult = ok ? "correct" : "wrong";
    // freeze input
    const ab = $("#answerBox");
    if (ab) { ab.disabled = true; ab.classList.add("opacity-70","cursor-not-allowed"); }

    state.history = [{
      t: Date.now(),
      ok,
      cardId: card.CardID,
      course: card.Course,
      unit: card.Unit,
      baseEN: card.BaseEN,
      expected: acceptedAnswers(card).join(" | "),
      got: state.guess
    }, ...state.history].slice(0, 500);

    saveLS("wv_hist", state.history);
    render();
  };

  const onNext = () => {
    state.p = (state.p + 1) % state.deck.length;
    state.guess = "";
    state.revealed = false;
    state.lastResult = null;
    render();
  };

  const onHint = () => {
    // open the base hint popover
    // (clicking the first info button inside baseBox)
    baseBox.querySelector(".info-btn")?.click();
    $("#answerBox")?.focus();
  };

  actions.append(
    btn("Check","btn-primary shadow", onCheck),
    btn("Hint","btn-ghost", onHint),
    btn("Next","btn-ghost", onNext)
  );

  // Feedback
  const feedback = document.createElement("div");
  feedback.className = "practice-feedback mt-4";
  feedback.setAttribute("aria-live","polite");

  if (state.revealed) {
    const ok = state.lastResult === "correct";
    const status = ok ? "‚úÖ Correct!" : "‚ùå Not quite";
    const why = (state.lang === "cy" ? (card.WhyCY || card.WhyEN) : (card.WhyEN || card.WhyCY)) || "";
    const accepted = acceptedAnswers(card);

    feedback.innerHTML = `
      <div class="feedback-box">
        <div class="text-2xl md:text-3xl font-semibold ${ok ? "text-indigo-900" : "text-rose-900"}">${esc(status)}</div>
        ${ok ? "" : `<div class="mt-1 text-slate-700">You typed: <b>${esc(state.guess || "(blank)")}</b></div>`}

        <div class="mt-4 text-slate-800 text-xl md:text-2xl flex items-baseline flex-wrap gap-x-3 gap-y-2">
          <span>${esc(card.BeforeCY || "")}</span>
          <span class="font-semibold bg-indigo-100 text-indigo-900 px-1 rounded">${esc(accepted[0] || "")}</span>
          <span>${esc(card.AfterCY || "")}</span>
        </div>

        ${accepted.length > 1 ? `<div class="mt-2 text-slate-700 text-sm">Also accepted: <b>${esc(accepted.slice(1).join(" ¬∑ "))}</b></div>` : ""}

        ${why ? `<div class="mt-4 text-slate-700">${esc(why)}</div>` : ""}

        <div class="mt-4 flex justify-end">
          <button id="inlineNext" class="btn btn-primary shadow" type="button">Next</button>
        </div>
      </div>
    `;
    setTimeout(() => $("#inlineNext")?.addEventListener("click", onNext), 0);
  }

  wrap.append(prompt, sentenceWrap, actions, feedback);
  host.appendChild(wrap);

  const ab = $("#answerBox");
  if (ab) {
    ab.value = state.guess;
    ab.focus();
    ab.addEventListener("input", (e) => state.guess = e.target.value);
    ab.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (!state.revealed) onCheck();
        else onNext();
      }
    });
  }
}

function renderBrowse() {
  const head = $("#browseHead");
  const body = $("#browseBody");
  if (!head || !body) return;

  head.innerHTML = "";
  body.innerHTML = "";
  const cols = ["Course","Unit","WordCategory","BaseEN","BeforeCY","AfterCY","AnswerCY","AnswerArray","Tags"];

  for (const h of cols) {
    const th = document.createElement("th");
    th.className = "text-left p-2 border-b";
    th.textContent = h;
    head.appendChild(th);
  }

  state.filtered.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.className = (i % 2 ? "bg-white" : "bg-slate-50");
    for (const k of cols) {
      const td = document.createElement("td");
      td.className = "p-2 align-top";
      td.textContent = r[k] || "";
      tr.appendChild(td);
    }
    body.appendChild(tr);
  });
}

function computeStats() {
  const total = state.history.length;
  const correct = state.history.filter(h => h.ok).length;
  const acc = total ? Math.round((correct / total) * 100) : 0;

  const byCourse = {};
  for (const h of state.history) {
    const c = h.course || "(none)";
    byCourse[c] = byCourse[c] || { total: 0, ok: 0 };
    byCourse[c].total++;
    if (h.ok) byCourse[c].ok++;
  }
  return { total, correct, acc, byCourse };
}

function renderStatsPanels() {
  const s = computeStats();
  $("#accBig") && ($("#accBig").textContent = `${s.acc}%`);
  $("#accText") && ($("#accText").textContent = `${s.correct} / ${s.total} correct`);
  $("#statsAcc") && ($("#statsAcc").textContent = `${s.acc}%`);
  $("#statsText") && ($("#statsText").textContent = `${s.correct} correct out of ${s.total}`);

  const ul1 = $("#byCourse");
  const ul2 = $("#statsByCourse");
  if (ul1) ul1.innerHTML = "";
  if (ul2) ul2.innerHTML = "";

  Object.entries(s.byCourse)
    .sort((a,b) => (b[1].total - a[1].total))
    .forEach(([k,v]) => {
      const li1 = document.createElement("li");
      li1.className = "flex justify-between";
      li1.innerHTML = `<span>${esc(k)}</span><span class="text-slate-600">${v.ok}/${v.total}</span>`;
      ul1?.appendChild(li1);

      const li2 = document.createElement("li");
      li2.className = "flex justify-between";
      li2.innerHTML = `<span>${esc(k)}</span><span class="text-slate-600">${v.ok}/${v.total}</span>`;
      ul2?.appendChild(li2);
    });
}

function render() {
  $("#practiceView")?.classList.toggle("hidden", state.mode !== "practice");
  $("#browseView")?.classList.toggle("hidden", state.mode !== "browse");
  $("#statsView")?.classList.toggle("hidden", state.mode !== "stats");

  renderPractice();
  if (state.mode === "browse") renderBrowse();
  renderStatsPanels();
}

/* ========= UI wiring ========= */
function applyLanguageButton() {
  const langBtn = $("#btnLangToggle");
  if (!langBtn) return;
  const nextLang = (state.lang === "en") ? "CY" : "EN";
  langBtn.innerHTML = `<span aria-hidden="true">üîÅ</span><span class="langtag">${nextLang}</span>`;
  langBtn.title = (state.lang === "en") ? "Switch to Cymraeg" : "Switch to English";
}
function wireUi() {
  $("#btnPractice")?.addEventListener("click", () => { state.mode = "practice"; saveLS("wv_mode", state.mode); render(); });
  $("#btnBrowse")?.addEventListener("click",   () => { state.mode = "browse";   saveLS("wv_mode", state.mode); render(); });
  $("#btnStats")?.addEventListener("click",    () => { state.mode = "stats";    saveLS("wv_mode", state.mode); render(); });

  $("#btnFilters")?.addEventListener("click", () => { $("#filtersPanel")?.classList.toggle("hidden"); });
  $("#btnHelp")?.addEventListener("click", () => { $("#onboard")?.classList.remove("hidden"); window.scrollTo({ top: 0, behavior: "smooth" }); });

  $("#btnLangToggle")?.addEventListener("click", () => {
    state.lang = (state.lang === "en") ? "cy" : "en";
    saveLS("wv_lang", state.lang);
    applyLanguageButton();
    render();
  });

  $("#onboardFilters")?.addEventListener("click", () => {
    $("#onboard")?.classList.add("hidden");
    $("#filtersPanel")?.classList.remove("hidden");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
  $("#onboardDismiss")?.addEventListener("click", () => $("#onboard")?.classList.add("hidden"));

  $("#btnResetStats")?.addEventListener("click", () => { state.history = []; saveLS("wv_hist", state.history); render(); });
  $("#btnResetStats2")?.addEventListener("click", () => { state.history = []; saveLS("wv_hist", state.history); render(); });

  $("#btnTop")?.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

  document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) || "";
    if (["INPUT", "TEXTAREA"].includes(tag.toUpperCase())) return;
    if (state.mode !== "practice") return;

    if (e.key === "Enter") {
      e.preventDefault();
      if (!state.revealed) $("#practiceCard #answerBox")?.dispatchEvent(new KeyboardEvent("keydown", {key:"Enter"}));
      else $("#inlineNext")?.click();
    }
  });

  $("#mbCheck")?.addEventListener("click", () => {
    const ab = $("#answerBox");
    if (!ab) return;
    ab.dispatchEvent(new KeyboardEvent("keydown", {key:"Enter"}));
  });
  $("#mbNext")?.addEventListener("click", () => $("#inlineNext")?.click() || (() => {})());
  $("#mbHint")?.addEventListener("click", () => {
    // open hint
    $("#practiceCard .info-btn")?.click();
    $("#answerBox")?.focus();
  });

  applyLanguageButton();
}

/* ========= Boot ========= */
(async function boot() {
  wireUi();
  await initData();
})();
</script>
</body>
</html>


