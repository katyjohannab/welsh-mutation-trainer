<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welsh Vocab Trainer</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css" />

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BBH+Bogle&family=BBH+Hegarty&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Slab:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body class="min-h-screen text-slate-900">
  <div id="app" class="min-h-screen flex flex-col text-[16px] md:text-[17px]">

    <!-- Header: keep structure consistent with your index page -->
    <header id="siteHeader" class="sticky top-0 z-10">
      <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between md:gap-4">
        <div class="brand-lockup grow min-w-0">
          <img class="brand-dragon" alt="" aria-hidden="true" src="https://katyjohannab.github.io/welsh-mutation-trainer/images/dragon.png" />
          <h1 class="bbh-bogle-regular brand-title text-3xl md:text-4xl lg:text-5xl tracking-tight">
            <span class="title-hy">Hyffordwr</span><span class="title-trei">Cymraeg</span>
          </h1>
        </div>

        <div class="flex flex-wrap items-center justify-start md:justify-end gap-2 md:gap-3">
          <span id="itemCount" class="hidden text-xs text-slate-500"></span>
          <span id="adminBadge" class="hidden text-xs font-semibold text-red-700 bg-red-50 border border-red-200 px-2 py-1 rounded-full">Admin</span>

          <!-- Primary nav -->
          <div class="flex flex-wrap items-center gap-2">
            <a class="btn btn-ghost" href="./home.html" title="Home">Home</a>
            <a class="btn btn-ghost" href="./learn.html" title="Learn">Learn</a>
            <a class="btn btn-ghost" href="./index.html" title="Mutations">Mutations</a>
            <button id="btnPractice" class="btn btn-primary" title="Vocab practice">Vocab</button>
          </div>

          <div class="hidden md:block h-6 w-px bg-slate-200/80"></div>

          <!-- Secondary actions -->
          <div class="flex flex-wrap items-center gap-2">
            <button id="btnStats" class="btn btn-ghost" title="Stats">Stats</button>
            <button id="btnFilters" class="btn btn-ghost" title="Filters">Filters</button>
            <button id="btnBrowse" class="btn btn-ghost" title="Browse">Browse</button>
            <button id="btnHelp" class="btn btn-ghost" title="Help">Help</button>
          </div>

          <div class="hidden md:block h-6 w-px bg-slate-200/80"></div>

          <button id="btnLangToggle" class="btn-lang" aria-label="Switch language" title="Switch language"></button>
        </div>
      </div>
      <div class="cymru-red-bar" aria-hidden="true"></div>
    </header>

    <!-- Onboarding -->
    <section id="onboard" class="max-w-6xl mx-auto p-4 mt-3">
      <div class="panel rounded-2xl p-4 flex items-start gap-3">
        <div class="text-2xl">üí°</div>
        <div class="text-sm text-slate-700">
          <div class="font-medium mb-1">Vocab mode (English ‚Üí Welsh)</div>
          <ol class="list-decimal ml-5 leading-relaxed">
            <li>Use <b>Random</b> or <b>Smart</b> review at the top of the card.</li>
            <li>Click <b>Filters</b> to pick Course, Unit, Word category, or search by tags.</li>
            <li>Read the Welsh sentence and type the matching Welsh word.</li>
            <li>Use the <b>?</b> next to the base word for a hint. Use the <b>?</b> by the sentence for word glosses.</li>
            <li>After checking, use <b>Hear</b> to play the completed Welsh sentence.</li>
          </ol>
          <div class="mt-3 flex gap-2">
            <button id="onboardFilters" class="btn btn-primary shadow">Open filters</button>
            <button id="onboardDismiss" class="btn btn-ghost">Got it</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Main panels -->
    <main id="main" class="grow max-w-6xl mx-auto p-4 pb-24 md:pb-4">
      <div id="practiceView" class="grid md:grid-cols-3 gap-4 items-start">
        <!-- Left: practice card -->
        <div class="md:col-span-2 panel rounded-2xl p-6 md:p-7">
          <div id="practiceCard"></div>
        </div>

        <!-- Right: filters + session -->
        <div class="md:col-span-1 flex flex-col gap-4">

          <div id="filtersPanel" class="panel rounded-2xl p-4 hidden">
            <!-- Admin tools -->
            <div id="adminPanel" class="hidden mb-4">
              <div class="text-sm font-medium mb-2">Admin tools</div>
              <label class="text-sm font-medium">Data URL </label>
              <div class="mt-2 flex gap-2">
                <input id="dataUrl" class="w-full border rounded-xl px-3 py-2" placeholder="Paste CSV URL">
                <button id="btnLoadUrl" class="btn btn-primary px-4 py-2">LOAD</button>
              </div>
              <div class="mt-3">
                <div class="text-sm font-medium mb-1">Load local CSV</div>
                <input id="fileCsv" type="file" accept=".csv" />
              </div>
              <hr class="my-4" />
            </div>

            <div class="text-sm font-medium mb-2">Filters</div>

            <!-- Quick difficulty toggle (doesn't replace Course/Unit, just a quick preset) -->
            <div class="mb-3">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Difficulty</div>
              <div class="seg">
                <button id="diffAll" class="seg-btn">ALL</button>
                <button id="diffEasy" class="seg-btn">EASY</button>
                <button id="diffHard" class="seg-btn">HARD</button>
              </div>
              <div class="mt-1 text-xs text-slate-500">Easy = Mynediad/Sylfaen ¬∑ Hard = Uwch 1‚Äì3</div>
            </div>

            <div class="grid gap-3 text-sm">
              <div>
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Course</div>
                <select id="courseSelect" class="w-full border rounded-xl px-3 py-2 bg-white"></select>
              </div>

              <div>
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Unit</div>
                <select id="unitSelect" class="w-full border rounded-xl px-3 py-2 bg-white"></select>
              </div>

              <div>
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Word category</div>
                <div id="wcBtns" class="flex flex-wrap gap-1"></div>
              </div>

              <div>
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Search tags / English</div>
                <input id="searchBox" class="w-full border rounded-xl px-3 py-2" placeholder="e.g. food, travel, rights, work" />
              </div>

              <div class="flex gap-2">
                <button id="btnClearFilters" class="btn btn-ghost px-3 py-2">Clear</button>
              </div>
            </div>
          </div>

          <aside id="sessionPanel" class="panel rounded-2xl p-4">
            <div class="text-sm font-medium mb-2">Session</div>
            <div id="accBig" class="text-5xl md:text-6xl font-semibold">0%</div>
            <div id="accText" class="text-sm text-slate-600">0 / 0 correct</div>
            <div id="cardPos" class="text-sm text-slate-600">Card 0 / 0</div>

            <div class="mt-3 text-sm">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">By course</div>
              <ul id="byCourse" class="space-y-1"></ul>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="btnResetStats" class="btn btn-ghost px-3 py-1.5">Reset stats</button>
            </div>
          </aside>
        </div>
      </div>

      <div id="browseView" class="hidden panel rounded-2xl overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr id="browseHead"></tr>
          </thead>
          <tbody id="browseBody"></tbody>
        </table>
      </div>

      <div id="statsView" class="hidden grid md:grid-cols-2 gap-4">
        <div class="panel rounded-2xl p-6">
          <h2 class="text-lg font-medium mb-2">Accuracy</h2>
          <div id="statsAcc" class="text-5xl font-bold">0%</div>
          <div id="statsText" class="text-slate-600">0 correct out of 0</div>
          <button id="btnResetStats2" class="mt-4 btn btn-ghost px-3 py-1.5">Reset</button>
        </div>
        <div class="panel rounded-2xl p-6">
          <h2 class="text-lg font-medium mb-2">By course</h2>
          <ul id="statsByCourse" class="space-y-1 text-sm"></ul>
        </div>
      </div>
    </main>

    <!-- Mobile action bar -->
    <div id="mobileBar" class="fixed md:hidden bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t shadow-lg p-2">
      <div class="max-w-6xl mx-auto flex gap-2">
        <button id="mbHint" title="Hint (H)" class="flex-1 btn btn-ghost px-3 py-2">Hint</button>
        <button id="mbCheck" title="Check (Enter)" class="flex-1 btn btn-primary px-3 py-2">Check</button>
        <button id="mbNext" title="Next (Enter)" class="flex-1 btn btn-ghost px-3 py-2">Next</button>
      </div>
    </div>

    <footer class="max-w-6xl mx-auto p-6 text-xs text-slate-500">
      <div class="flex flex-wrap gap-4 items-center">
        <span>¬© Hyffordwr Cymraeg</span>
        <button id="btnTop" class="ml-auto btn btn-ghost px-2 py-1">Back to top</button>
      </div>
    </footer>
  </div>

<script>
/* ========= Utilities ========= */
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

function normalize(s) {
  return (s || "")
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/‚Äô/g, "'")
    .toLowerCase()
    .trim()
    .replace(/\s+/g, " ");
}
function esc(s) {
  return (s == null ? "" : String(s)).replace(/[&<>"]/g, ch => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;"
  }[ch]));
}
function download(text, filename, type = "text/plain") {
  const blob = new Blob([text], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function getParam(k) { return new URLSearchParams(location.search).get(k); }
function saveLS(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) {} }
function loadLS(k, d) { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) : d; } catch (e) { return d; } }

function toggleBtn(text, active, onToggle) {
  const b = document.createElement("button");
  b.type = "button";
  b.className = `pill ${active ? "pill-on" : ""}`;
  b.textContent = text;
  b.onclick = () => onToggle(!active);
  return b;
}

/* ========= Practice mode (Random / Smart - Leitner) ========= */
const PRACTICE_MODE_LS_KEY = "vocab_practice_mode_v1";
const LEITNER_LS_KEY = "vocab_leitner_boxes_v1";
const LEITNER_MAX_BOX = 5;
const LEITNER_WEIGHTS = [0, 50, 25, 15, 7, 3]; // index 1..5

function clampBox(n) {
  const x = Number(n);
  if (!Number.isFinite(x)) return 1;
  return Math.max(1, Math.min(LEITNER_MAX_BOX, Math.round(x)));
}
function getBoxFor(cardId) {
  return clampBox(state.leitner?.[cardId] ?? 1);
}
function setBoxFor(cardId, box) {
  if (!state.leitner) state.leitner = {};
  state.leitner[cardId] = clampBox(box);
  saveLS(LEITNER_LS_KEY, state.leitner);
}
function updateLeitner(cardId, result) {
  const cur = getBoxFor(cardId);
  const next = (result === "correct") ? Math.min(LEITNER_MAX_BOX, cur + 1) : 1;
  setBoxFor(cardId, next);
}
function weightedPickBox(candidatesByBox) {
  let total = 0;
  for (let b = 1; b <= LEITNER_MAX_BOX; b++) {
    if (candidatesByBox[b]?.length) total += LEITNER_WEIGHTS[b];
  }
  if (!total) return 1;
  let r = Math.random() * total;
  for (let b = 1; b <= LEITNER_MAX_BOX; b++) {
    if (!candidatesByBox[b]?.length) continue;
    r -= LEITNER_WEIGHTS[b];
    if (r <= 0) return b;
  }
  return 1;
}
function pickNextSmartIdx() {
  const n = state.filtered?.length || 0;
  if (!n) return 0;

  if (!Array.isArray(state.smartQueue)) state.smartQueue = [];

  // decrement retry timers, serve first due that's not the current one
  if (state.smartQueue.length) {
    state.smartQueue.forEach(item => item.dueAfter = Math.max(0, (item.dueAfter || 0) - 1));
    const duePos = state.smartQueue.findIndex(item => (item.dueAfter || 0) === 0 && item.idx !== state.smartIdx);
    if (duePos >= 0) {
      const item = state.smartQueue.splice(duePos, 1)[0];
      return item.idx;
    }
  }

  const byBox = { 1: [], 2: [], 3: [], 4: [], 5: [] };
  for (let i = 0; i < n; i++) {
    const id = state.filtered[i]?.CardID || `row_${i}`;
    const box = getBoxFor(id);
    byBox[box].push(i);
  }

  let chosenBox = weightedPickBox(byBox);
  if (!byBox[chosenBox].length) {
    for (let b = 1; b <= LEITNER_MAX_BOX; b++) {
      if (byBox[b].length) { chosenBox = b; break; }
    }
  }

  const pool = byBox[chosenBox] || [];
  if (!pool.length) return Math.floor(Math.random() * n);

  let idx = pool[Math.floor(Math.random() * pool.length)];
  for (let tries = 0; tries < 6 && idx === state.smartIdx && pool.length > 1; tries++) {
    idx = pool[Math.floor(Math.random() * pool.length)];
  }
  return idx;
}

/* ========= TTS (Polly via Lambda URL) ========= */
const POLLY_FUNCTION_URL = "https://pl6xqfeht2hhbruzlhm3imcpya0upied.lambda-url.eu-west-2.on.aws/";
const ttsCache = new Map();

function buildCompleteSentence(card, answerOverride = null) {
  const before = (card.BeforeCY || "").trimEnd();
  const answer = (answerOverride != null ? answerOverride : (card.AnswerCY || "")).trim();
  const after  = (card.AfterCY || "").trimStart();
  let s = [before, answer, after].filter(Boolean).join(" ");
  s = s.replace(/\s+/g, " ").trim();
  s = s.replace(/\s+([,.;:!?])/g, "$1");
  return s;
}
async function playPollySentence(sentence) {
  if (!sentence) throw new Error("No sentence to speak.");
  const cachedUrl = ttsCache.get(sentence);
  if (cachedUrl) {
    const audio = new Audio(cachedUrl);
    await audio.play();
    return;
  }

  const res = await fetch(POLLY_FUNCTION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: sentence })
  });

  if (!res.ok) {
    const msg = await res.text().catch(() => "");
    throw new Error(msg || `TTS failed (${res.status})`);
  }

  const ct = (res.headers.get("content-type") || "").toLowerCase();
  let url = null;

  if (ct.includes("audio") || ct.includes("octet-stream")) {
    const buf = await res.arrayBuffer();
    const blob = new Blob([buf], { type: "audio/mpeg" });
    url = URL.createObjectURL(blob);
  } else {
    const j = await res.json();
    if (j.url) url = j.url;
    else if (j.audioBase64 || j.audioContent) {
      const b64 = j.audioBase64 || j.audioContent;
      const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const blob = new Blob([bytes], { type: "audio/mpeg" });
      url = URL.createObjectURL(blob);
    } else {
      throw new Error("TTS response didn't include audio.");
    }
  }

  ttsCache.set(sentence, url);
  const audio = new Audio(url);
  await audio.play();
}

/* ========= ‚Äú?‚Äù popover UI (reuses your existing base-info-* styling) ========= */
function mountInfoPopover(hostEl, htmlBody, ariaLabel = "Help") {
  if (!hostEl) return;
  if (!htmlBody || !String(htmlBody).trim()) return;

  // anchor absolute-positioned ‚Äú?‚Äù to the host (THIS fixes drifting and spacing weirdness)
  hostEl.style.position = "relative";

  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "base-info-btn";
  btn.textContent = "?";
  btn.setAttribute("aria-label", ariaLabel);
  btn.setAttribute("title", ariaLabel);

  const pop = document.createElement("div");
  pop.className = "base-info-popover hidden animate-pop";
  pop.setAttribute("role", "dialog");

  const close = document.createElement("button");
  close.type = "button";
  close.className = "base-info-close";
  close.setAttribute("aria-label", "Close");
  close.textContent = "√ó";

  pop.innerHTML = htmlBody;
  pop.appendChild(close);

  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    const isHidden = pop.classList.contains("hidden");
    $$(".base-info-popover").forEach(p => p.classList.add("hidden"));
    if (isHidden) pop.classList.remove("hidden");
    else pop.classList.add("hidden");
  });

  close.addEventListener("click", (e) => {
    e.stopPropagation();
    pop.classList.add("hidden");
  });

  pop.addEventListener("click", (e) => e.stopPropagation());

  hostEl.appendChild(btn);
  hostEl.appendChild(pop);
}

// Global closer (single listeners)
document.addEventListener("click", () => {
  $$(".base-info-popover").forEach(p => p.classList.add("hidden"));
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") $$(".base-info-popover").forEach(p => p.classList.add("hidden"));
});

/* ========= Data loading ========= */
function getVal(row, names) {
  const keys = Object.keys(row || {});
  for (const key of keys) {
    if (names.some(n => key.trim().toLowerCase() === n.trim().toLowerCase())) {
      return (row[key] ?? "").toString();
    }
  }
  return "";
}

function coerceRow(r) {
  const row = r || {};
  const answerCY = getVal(row, ["AnswerCY","Answer","Welsh","Answer (CY)"]).trim();
  const answerArrayRaw = getVal(row, ["AnswerArray","Answer Array","Answers"]).trim();
  const answers = []
    .concat(answerArrayRaw ? answerArrayRaw.split("|") : [])
    .map(s => (s || "").trim())
    .filter(Boolean);

  // Ensure AnswerCY is included as an accepted answer if present
  if (answerCY && !answers.map(normalize).includes(normalize(answerCY))) answers.unshift(answerCY);

  return {
    CardID: getVal(row, ["CardID","CardId","ID","Id"]).trim(),
    Course: getVal(row, ["Course"]).trim(),
    Unit: getVal(row, ["Unit"]).trim(),
    WordCategory: getVal(row, ["WordCategory","Word Category"]).trim(),
    BaseEN: getVal(row, ["BaseEN","Base EN","Base"]).trim(),
    HintEN: getVal(row, ["HintEN","Hint EN"]).trim(),
    HintCY: getVal(row, ["HintCY","Hint CY"]).trim(),
    BeforeCY: getVal(row, ["BeforeCY","Before CY","Before"]).trim(),
    AfterCY: getVal(row, ["AfterCY","After CY","After"]).trim(),
    SentenceHelpEN: getVal(row, ["SentenceHelpEN","Sentence Help EN","SentenceHelp","Sentence Help"]).trim(),
    AnswerCY: answerCY,
    AnswerArray: answers,
    WhyEN: getVal(row, ["WhyEN","Why EN","Why"]).trim(),
    WhyCY: getVal(row, ["WhyCY","Why CY"]).trim(),
    Tags: getVal(row, ["Tags","Tag"]).trim()
  };
}

async function loadCsvUrl(u) {
  return new Promise((resolve, reject) => {
    Papa.parse(u, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res) => resolve(res.data),
      error: reject
    });
  });
}

function isAbsUrl(u) { return /^https?:\/\//i.test(u || ""); }
function resolveFromRoot(path, root) {
  const p = (path || "").toString().trim();
  if (!p) return "";
  if (isAbsUrl(p)) return p;
  return new URL(p.replace(/^\/+/, ""), root).toString();
}
async function fetchIndexList(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error("Failed to fetch index: " + url);
  const j = await r.json();
  if (!Array.isArray(j)) throw new Error("Index JSON is not an array: " + url);
  return j;
}

const FALLBACK_INDEX_URL = "https://katyjohannab.github.io/welsh-mutation-trainer/data/vocab/index.json";
const FALLBACK_SITE_ROOT = "https://katyjohannab.github.io/welsh-mutation-trainer/";

async function loadAllDefault() {
  let list = null;
  let usingFallbackRoot = false;

  try {
    list = await fetchIndexList("data/vocab/index.json");
  } catch (e) {
    list = await fetchIndexList(FALLBACK_INDEX_URL);
    usingFallbackRoot = true;
  }

  const root = usingFallbackRoot ? FALLBACK_SITE_ROOT : new URL(".", location.href).toString();
  let merged = [];
  for (const p of list) {
    const url = resolveFromRoot(p, root);
    if (!url) continue;
    try {
      const d = await loadCsvUrl(url);
      merged = merged.concat(d);
    } catch (err) {
      console.warn("Failed to load source:", url, err);
    }
  }
  return merged;
}

/* ========= App State ========= */
const state = {
  rows: [],
  filtered: [],
  mode: loadLS("vocab_mode", "practice"),

  // Filters
  diffPreset: loadLS("vocab_diff", "all"),        // all | easy | hard
  course: loadLS("vocab_course", ""),
  unit: loadLS("vocab_unit", ""),
  wordCats: loadLS("vocab_wc", []),               // multi-select
  search: loadLS("vocab_search", ""),

  // Practice
  practiceMode: loadLS(PRACTICE_MODE_LS_KEY, "shuffle"),  // shuffle | smart
  leitner: loadLS(LEITNER_LS_KEY, {}),
  smartIdx: null,
  smartCount: 0,
  smartQueue: [],
  deck: [],
  p: 0,
  guess: "",
  revealed: false,
  lastResult: null,
  freezeIdx: null,
  freezePos: null,

  history: loadLS("vocab_hist", []),
  admin: getParam("admin") === "1",

  lang: loadLS("vocab_lang", "en"),
  currentIdx: 0,
  currentDeckPos: -1,
};

const COURSE_EASY = new Set(["Mynediad","Sylfaen"]);
const COURSE_HARD = new Set(["Uwch 1","Uwch 2","Uwch 3","Uwch1","Uwch2","Uwch3"]);

function applyDiffPreset(list) {
  if (state.course) return list; // explicit course overrides preset
  if (state.diffPreset === "easy") return list.filter(r => COURSE_EASY.has(r.Course));
  if (state.diffPreset === "hard") return list.filter(r => COURSE_HARD.has(r.Course));
  return list;
}

function applyFilters() {
  let list = state.rows.slice();

  list = applyDiffPreset(list);

  if (state.course) list = list.filter(r => r.Course === state.course);
  if (state.unit) list = list.filter(r => r.Unit === state.unit);
  if (state.wordCats?.length) list = list.filter(r => state.wordCats.includes(r.WordCategory));

  const q = (state.search || "").trim();
  if (q) {
    const nq = normalize(q);
    list = list.filter(r => {
      const hay = [
        r.BaseEN, r.Tags, r.HintEN, r.BeforeCY, r.AfterCY, r.Course, r.Unit, r.WordCategory
      ].filter(Boolean).join(" ‚Ä¢ ");
      return normalize(hay).includes(nq);
    });
  }

  state.filtered = list;
}

function rebuildDeck() {
  const n = state.filtered.length;
  const d = Array.from({ length: n }, (_, i) => i);
  for (let i = d.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [d[i], d[j]] = [d[j], d[i]];
  }
  state.deck = d;
  state.p = 0;
  state.guess = "";
  state.revealed = false;
  state.lastResult = null;
  state.freezeIdx = null;
  state.freezePos = null;
  state.smartQueue = [];

  if (state.practiceMode === "smart") {
    state.smartCount = 0;
    state.smartIdx = pickNextSmartIdx();
  } else {
    state.smartIdx = null;
    state.smartCount = 0;
  }
}

/* ========= UI: Language toggle text ========= */
function applyLanguage() {
  const langBtn = $("#btnLangToggle");
  if (langBtn) {
    const nextLang = (state.lang === "en") ? "CY" : "EN";
    langBtn.innerHTML = `<span aria-hidden="true">üîÅ</span><span class="langtag">${nextLang}</span>`;
    langBtn.title = (state.lang === "en") ? "Switch to Cymraeg" : "Switch to English";
    langBtn.setAttribute("aria-label", (state.lang === "en") ? "Switch language to Cymraeg" : "Switch language to English");
  }
}

/* ========= Filters UI build ========= */
function buildFilterControls() {
  // Difficulty buttons (seg)
  const setDiffBtnState = () => {
    const map = { all:"#diffAll", easy:"#diffEasy", hard:"#diffHard" };
    Object.values(map).forEach(id => $(id)?.classList.remove("is-on"));
    const activeId = map[state.diffPreset] || "#diffAll";
    $(activeId)?.classList.add("is-on");
    [$("#diffAll"), $("#diffEasy"), $("#diffHard")].forEach(b => {
      if (!b) return;
      b.setAttribute("aria-pressed", b.classList.contains("is-on") ? "true" : "false");
    });
  };

  $("#diffAll")?.addEventListener("click", () => {
    state.diffPreset = "all";
    saveLS("vocab_diff", state.diffPreset);
    applyFilters(); rebuildDeck(); buildFilterControls(); render();
  });
  $("#diffEasy")?.addEventListener("click", () => {
    state.diffPreset = "easy";
    state.course = ""; state.unit = "";
    saveLS("vocab_diff", state.diffPreset);
    saveLS("vocab_course", state.course);
    saveLS("vocab_unit", state.unit);
    applyFilters(); rebuildDeck(); buildFilterControls(); render();
  });
  $("#diffHard")?.addEventListener("click", () => {
    state.diffPreset = "hard";
    state.course = ""; state.unit = "";
    saveLS("vocab_diff", state.diffPreset);
    saveLS("vocab_course", state.course);
    saveLS("vocab_unit", state.unit);
    applyFilters(); rebuildDeck(); buildFilterControls(); render();
  });

  setDiffBtnState();

  // Course dropdown
  const courseSel = $("#courseSelect");
  const unitSel = $("#unitSelect");

  const courses = Array.from(new Set(state.rows.map(r => r.Course).filter(Boolean))).sort();
  if (courseSel) {
    courseSel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "All courses";
    courseSel.appendChild(opt0);
    courses.forEach(c => {
      const o = document.createElement("option");
      o.value = c; o.textContent = c;
      courseSel.appendChild(o);
    });
    courseSel.value = state.course || "";
    courseSel.onchange = (e) => {
      state.course = e.target.value;
      state.unit = "";
      // Choosing a specific course implies preset "all" (otherwise it feels contradictory)
      state.diffPreset = "all";
      saveLS("vocab_course", state.course);
      saveLS("vocab_unit", state.unit);
      saveLS("vocab_diff", state.diffPreset);
      applyFilters(); rebuildDeck(); buildFilterControls(); render();
    };
  }

  // Unit dropdown depends on current course/preset
  const unitsBase = applyDiffPreset(state.rows.slice())
    .filter(r => !state.course || r.Course === state.course)
    .map(r => r.Unit)
    .filter(Boolean);

  const units = Array.from(new Set(unitsBase)).sort((a,b) => a.localeCompare(b, undefined, { numeric:true, sensitivity:"base" }));

  if (unitSel) {
    unitSel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "All units";
    unitSel.appendChild(opt0);
    units.forEach(u => {
      const o = document.createElement("option");
      o.value = u; o.textContent = u;
      unitSel.appendChild(o);
    });
    unitSel.value = state.unit || "";
    unitSel.onchange = (e) => {
      state.unit = e.target.value;
      saveLS("vocab_unit", state.unit);
      applyFilters(); rebuildDeck(); render();
    };
  }

  // WordCategory pills
  const wcHost = $("#wcBtns");
  if (wcHost) {
    wcHost.innerHTML = "";
    const cats = Array.from(new Set(state.rows.map(r => r.WordCategory).filter(Boolean))).sort();
    const allActive = !state.wordCats?.length;

    wcHost.appendChild(toggleBtn("All", allActive, () => {
      state.wordCats = [];
      saveLS("vocab_wc", state.wordCats);
      applyFilters(); rebuildDeck(); buildFilterControls(); render();
    }));

    cats.forEach(c => {
      const active = state.wordCats.includes(c);
      wcHost.appendChild(toggleBtn(c, active, (on) => {
        state.wordCats = on ? Array.from(new Set([...state.wordCats, c])) : state.wordCats.filter(x => x !== c);
        saveLS("vocab_wc", state.wordCats);
        applyFilters(); rebuildDeck(); render();
      }));
    });
  }

  // Search box
  const sb = $("#searchBox");
  if (sb) {
    sb.value = state.search || "";
    sb.oninput = (e) => {
      state.search = e.target.value;
      saveLS("vocab_search", state.search);
      applyFilters(); rebuildDeck(); render();
    };
  }

  $("#btnClearFilters")?.addEventListener("click", () => {
    state.diffPreset = "all";
    state.course = "";
    state.unit = "";
    state.wordCats = [];
    state.search = "";
    saveLS("vocab_diff", state.diffPreset);
    saveLS("vocab_course", state.course);
    saveLS("vocab_unit", state.unit);
    saveLS("vocab_wc", state.wordCats);
    saveLS("vocab_search", state.search);
    applyFilters(); rebuildDeck(); buildFilterControls(); render();
  });
}

/* ========= Render ========= */
function renderPractice() {
  const host = $("#practiceCard");
  if (!host) return;
  host.innerHTML = "";

  const n = state.filtered.length;
  if (!n) {
    host.innerHTML = `
      <div class="text-slate-700 panel rounded-xl p-4">
        No cards match your filters.
        <button id="localClear" class="ml-2 btn btn-ghost px-2 py-1">Clear filters</button>
      </div>`;
    $("#localClear")?.addEventListener("click", () => $("#btnClearFilters")?.click());
    return;
  }

  // pick current card
  let idxNow;
  let posText = "";

  if (state.practiceMode === "smart") {
    if (state.smartIdx == null) state.smartIdx = pickNextSmartIdx();
    idxNow = state.smartIdx;
    state.currentDeckPos = -1;
    const reviewed = (state.smartCount || 0) + 1;
    posText = `Reviewed ${reviewed} ¬∑ Pool ${n}`;
    $("#cardPos").textContent = `Smart ¬∑ ${posText}`;
  } else {
    const deckIdx = state.p % state.deck.length;
    idxNow = state.deck[deckIdx];
    state.currentDeckPos = deckIdx;
    const pos = state.deck.length ? (deckIdx + 1) : 0;
    posText = `Card ${pos} / ${state.deck.length || 0}`;
    $("#cardPos").textContent = posText;
  }

  const idxShown = (state.revealed && state.freezeIdx != null) ? state.freezeIdx : idxNow;
  const card = state.filtered[idxShown];
  state.currentIdx = idxNow;

  const wrap = document.createElement("div");

  // Header row: position + Random/Smart seg (this restores the missing toggle)
  const header = document.createElement("div");
  header.className = "flex flex-wrap items-center justify-between gap-2 mb-3";

  const headerLeft = document.createElement("div");
  headerLeft.className = "flex flex-wrap items-center gap-2 text-xs text-slate-500";
  headerLeft.textContent = posText;

  const headerRight = document.createElement("div");
  headerRight.className = "flex items-center gap-2";

  const seg = document.createElement("div");
  seg.className = "seg";

  const mkSegBtn = (labelText, value) => {
    const b = document.createElement("button");
    b.type = "button";
    const on = state.practiceMode === value;
    b.className = `seg-btn ${on ? "is-on" : ""}`;
    b.setAttribute("aria-pressed", on ? "true" : "false");
    b.textContent = String(labelText).toUpperCase();
    b.onclick = () => {
      if (state.practiceMode === value) return;
      state.practiceMode = value;
      saveLS(PRACTICE_MODE_LS_KEY, state.practiceMode);
      rebuildDeck();
      render();
    };
    return b;
  };

  seg.append(
    mkSegBtn("Random", "shuffle"),
    mkSegBtn("Smart", "smart")
  );

  headerRight.appendChild(seg);
  header.append(headerLeft, headerRight);

  // Instruction
  const instruction = document.createElement("div");
  instruction.className = "practice-instruction text-lg md:text-xl text-slate-700 mb-5";
  instruction.textContent = "Type the Welsh word that matches the English base word.";

  // Base capsule (English), styled like your index page
  const baseBlock = document.createElement("div");
  baseBlock.className = "mb-3";

  const capsule = document.createElement("div");
  capsule.className = "inline-flex items-baseline bg-indigo-100 ring-1 ring-indigo-300 rounded-2xl px-5 py-3 shadow-sm pr-12";
  // pr-12 gives the ‚Äú?‚Äù breathing room so it isn‚Äôt cramped into the corner
  const baseSpan = document.createElement("span");
  baseSpan.className = "base-word-text text-indigo-900 text-3xl md:text-4xl font-bold tracking-tight";
  baseSpan.textContent = card.BaseEN || "‚Äî";
  capsule.appendChild(baseSpan);

  // Base ‚Äú?‚Äù: show hint (EN + optional CY)
  const hintParts = [];
  if (card.HintEN) hintParts.push(`<div class="base-info-meaning">${esc(card.HintEN)}</div>`);
  if (card.HintCY) hintParts.push(`<div class="base-info-meaning">${esc(card.HintCY)}</div>`);
  const hintHtml = hintParts.join("");
  mountInfoPopover(capsule, hintHtml, "Hint");

  baseBlock.appendChild(capsule);

  // Meta chips under base word (course / unit / word category)
  const meta = document.createElement("div");
  meta.className = "flex flex-wrap gap-2 mt-3";
  const addMetaChip = (txt) => {
    const c = document.createElement("span");
    c.className = "chip";
    c.textContent = txt;
    return c;
  };
  if (card.Course) meta.appendChild(addMetaChip(card.Course));
  if (card.Unit) meta.appendChild(addMetaChip(card.Unit));
  if (card.WordCategory) meta.appendChild(addMetaChip(card.WordCategory));
  baseBlock.appendChild(meta);

  // Sentence capsule (Welsh sentence with input) + sentence ‚Äú?‚Äù for glosses
  const sentenceWrap = document.createElement("div");
  sentenceWrap.className = "mt-5";

  // This is the key spacing fix:
  // - inline-block so the ‚Äú?‚Äù sits at the top-right of the sentence chunk, not the far right edge of the card
  // - pr-12 so the ‚Äú?‚Äù has breathing space
  const sentenceCapsule = document.createElement("div");
  sentenceCapsule.className = "inline-block max-w-full relative pr-12";

  sentenceCapsule.innerHTML = `
    <div class="practice-sentenceLine flex flex-wrap items-baseline gap-2 text-xl md:text-2xl">
      <span class="text-slate-600">${esc(card.BeforeCY || "")}</span>
      <input id="answerBox"
        class="border-2 border-slate-300 focus:border-cyan-600 outline-none bg-amber-50 px-3 py-2 rounded-xl text-2xl md:text-3xl leading-tight shadow-sm w-auto md:w-60 flex-shrink-0"
        placeholder="Type Welsh"
        aria-label="Answer" />
      <span class="text-slate-600">${esc(card.AfterCY || "")}</span>
    </div>
  `;

  // Sentence ‚Äú?‚Äù: show SentenceHelpEN (glosses / translation cues)
  const sentHelp = (card.SentenceHelpEN || "").trim();
  if (sentHelp) {
    const html = `<div class="base-info-meaning">${esc(sentHelp)}</div>`;
    mountInfoPopover(sentenceCapsule, html, "Sentence help");
  }

  sentenceWrap.appendChild(sentenceCapsule);

  // Actions row (Check / Hint / Next) ‚Äì uses your existing button styles
  const actions = document.createElement("div");
  actions.className = "practice-actions flex flex-wrap gap-3 mt-4";

  const main = document.createElement("div");
  main.className = "practice-actions-main";

  const hintBox = document.createElement("div");
  hintBox.className = "hidden practice-hint text-sm text-slate-600 mt-3";

  const acceptedAnswers = Array.isArray(card.AnswerArray) ? card.AnswerArray : [];
  const canonicalAnswer = acceptedAnswers[0] || card.AnswerCY || "";

  const showHint = () => {
    const first = canonicalAnswer ? canonicalAnswer.slice(0,1) : "?";
    const extra = card.HintEN ? ` ¬∑ ${card.HintEN}` : "";
    hintBox.innerHTML = `Hint: starts with <b>${esc(first)}</b>${extra ? `<span>${esc(extra)}</span>` : ""}`;
    hintBox.classList.remove("hidden");
    $("#answerBox")?.focus();
  };

  const onCheck = () => {
    const guess = state.guess || "";
    const ok = acceptedAnswers.some(a => normalize(a) === normalize(guess));

    state.revealed = true;
    state.lastResult = ok ? "correct" : "wrong";
    state.freezeIdx = idxNow;
    state.freezePos = state.currentDeckPos;

    const cardId = card.CardID || `row_${idxShown}`;
    state.history = [{
      t: Date.now(),
      ok,
      cardId,
      course: card.Course || "",
      expected: acceptedAnswers.join("|"),
      got: guess,
      mode: state.practiceMode
    }, ...state.history].slice(0, 1000);
    saveLS("vocab_hist", state.history);

    updateLeitner(cardId, ok ? "correct" : "wrong");
    if (!ok && state.practiceMode === "smart") {
      state.smartQueue.push({ idx: idxShown, dueAfter: 2 });
    }

    const ab = $("#answerBox");
    if (ab) {
      ab.disabled = true;
      ab.classList.add("opacity-70", "cursor-not-allowed");
    }
    render();
    setTimeout(() => $("#inlineNext")?.focus({ preventScroll: true }), 0);
  };

  const btnCheck = document.createElement("button");
  btnCheck.type = "button";
  btnCheck.id = "btnCheck";
  btnCheck.className = "btn btn-primary shadow";
  btnCheck.textContent = "Check";
  btn


