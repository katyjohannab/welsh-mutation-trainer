<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welsh Mutation Trainer</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=BBH+Bogle&family=BBH+Hegarty&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Roboto+Slab:wght@100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

    /*Fonts Styling*/
    .bbh-bogle-regular {
      font-family: "BBH Bogle", sans-serif;
      font-weight: 400;
      font-style: normal;
    }

    .bbh-hegarty-regular {
      font-family: "BBH Hegarty", sans-serif;
      font-weight: 400;
      font-style: normal;
    }

    .merriweather-title {
      font-family: "Merriweather", serif;
      font-optical-sizing: auto;
      font-weight: 700;
      font-style: italic;
      font-variation-settings:
        "wdth" 100;
    }

    .inter-body {
      font-family: "Inter", sans-serif;
      font-optical-sizing: auto;
      font-weight: 400;
      font-style: normal;
    }

    .roboto-body {
      font-family: "Roboto", sans-serif;
      font-optical-sizing: auto;
      font-weight: 400;
      font-style: normal;
      font-variation-settings:
        "wdth" 100;
    }

    /* -------------------------
       Theme: clean paper + Cymru accents
       - No gradient header background
       - Keep gradients as accents only
    ------------------------- */
    :root {
      /* primary button gradient (emerald) */
      --primary-from: #0b7a5a; /* lighter title-green */
      --primary-mid:  #065f46; /* title-green mid */
      --primary-to:   #064e3b; /* title ink */

      /* page */
      --page: #fbfbf7;                 /* warm paper */
      --page-tint: rgba(6,95,70,0.04); /* faint green wash */

      /* surfaces */
      --surface: rgba(255,255,255,0.94);
      --border: rgba(15,23,42,0.10);
      --shadow: 0 12px 30px rgba(15,23,42,0.06);

      /* text */
      --text: #0f172a;
      --muted: #475569;

      /* accents */
      --emerald-ink: #064e3b;
      --gold: #d97706;
      --cymru-red: #b91c1c;      /* red-700 */
      --cymru-red-ink: #991b1b;  /* red-800 */

      /* chips */
      --chip-bg: rgba(4,120,87,0.10);
      --chip-bd: rgba(4,120,87,0.22);
      --chip-fg: #065f46;

      --focus: rgba(4,120,87,0.35);
    }

    body{
      background: var(--page);
      background-image:
        radial-gradient(900px 520px at 20% -10%, var(--page-tint), transparent 60%),
        radial-gradient(900px 620px at 90% 0%, rgba(217,119,6,0.03), transparent 55%),
        radial-gradient(900px 560px at 95% 95%, rgba(185,28,28,0.02), transparent 60%);
      color: var(--text);
    }

    /* Glass panel used for cards, filters and stats */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* red gradient bar under header */
    .cymru-red-bar{
      height: 3px;
      /* Tie the brand together: emerald â†’ Cymru red */
      background: linear-gradient(to right,
        transparent 0%,
        rgba(4,120,87,0.20) 12%,
        rgba(4,120,87,0.92) 28%,
        rgba(4,120,87,1.00) 40%,
        rgba(185,28,28,1.00) 60%,
        rgba(185,28,28,0.92) 72%,
        rgba(185,28,28,0.20) 88%,
        transparent 100%
      );
    }

    /* Brand lockup (icon + title) */
    .brand-lockup{
      display:flex;
      align-items:center;
      gap:.65rem;
      min-width:0;
    }

    /* Title colours + dot separator (green â†’ red) */
    .brand-title{
      display:flex;
      align-items:center;
      gap:0;
      line-height:1;
      white-space:nowrap;
    }
    .title-hy{ color: var(--emerald-ink); }
    .title-trei{ color: var(--cymru-red-ink); margin-left: .06em; }
    .cymru-dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--cymru-red-ink);
      margin: 0 .55rem;
      flex: 0 0 auto;
      display: inline-block;
      align-self: center;
    }
    @media (min-width: 768px){
      .cymru-dot{ width: 9px; height: 9px; margin: 0 .65rem; }
    }

    .brand-dragon{
      width: 34px;
      height: 34px;
      display:block;
      flex: 0 0 auto;
      background: transparent;
      border: 0;
      filter: drop-shadow(0 10px 18px rgba(2,6,23,0.10));
      transform: translateY(-1px);
    }
    @media (min-width: 768px){
      .brand-dragon{ width: 44px; height: 44px; }
      .cymru-dot{
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--cymru-red-ink);
      box-shadow: 0 0 0 4px rgba(153,27,27,0.10);
      flex: 0 0 auto;
      align-self: center;
    }
    }

@keyframes pop{0%{transform:scale(.98);opacity:0}100%{transform:scale(1);opacity:1}}
    .animate-pop{animation:pop .18s ease-out both}

    .kbd { padding: 2px 6px; border: 1px solid #cbd5e1; border-radius: 6px; background:#f8fafc; font-size: 12px; }
    .chip {
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:6px 12px;
      font-size:11.5px;
      font-weight:750;
      letter-spacing:.08em;
      text-transform:uppercase;
      border:1px solid rgba(217,119,6,0.28);
      background:rgba(217,119,6,0.08);
      color:rgba(15,23,42,0.86);
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      cursor:default;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Button styles */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
      padding:.55rem .95rem;
      border-radius:999px;
      border:1px solid transparent;
      font-weight:600;
      line-height:1;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease, filter .12s ease;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:3px solid var(--focus); outline-offset:2px}

    .btn-primary{
      color:#fff;
      font-weight:600;
      background: linear-gradient(135deg, var(--primary-from) 0%, var(--primary-mid) 45%, var(--primary-to) 100%);
      background-size: 140% 140%;
      border: 1px solid rgba(255,255,255,0.14);
      position: relative;
      overflow:hidden;
      box-shadow: 0 10px 20px rgba(2,6,23,0.12), inset 0 1px 0 rgba(255,255,255,0.18);
    }
    .btn-primary:hover{
      transform: translateY(-1px);
      filter: saturate(1.06) brightness(1.02);
      box-shadow:0 14px 28px rgba(2,6,23,.16);
    }
    .btn-primary::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.18), transparent);
      transform: translateX(-120%);
      transition: transform .55s ease;
      pointer-events:none;
    }
    .btn-primary:hover::after{ transform: translateX(120%); }

    .btn-ghost{
      background:rgba(255,255,255,.76);
      border:1px solid var(--border);
      color:#0f172a;
      box-shadow: 0 1px 0 rgba(2,6,23,0.02);
    }
    .btn-ghost:hover{
      background:rgba(255,255,255,.94);
      border-color: rgba(185,28,28,0.22); /* sparing Cymru red echo */
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(2,6,23,0.08);
    }

    /* Custom style for the audio playback button.  It is intentionally
       compact with an inline icon to clearly convey its purpose.  The
       emerald palette ties it back to the siteâ€™s theme without
       overpowering the surrounding content. */
    .btn-hear{
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      background: rgba(4,120,87,0.10);
      border: 1px solid rgba(4,120,87,0.26);
      color: var(--emerald-ink);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      padding: 0.28rem 0.6rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem; /* 14px for compactness */
      line-height: 1;
      transition: transform .06s ease, background .12s ease, box-shadow .12s ease;
      cursor: pointer;
    }
    .btn-hear .icon{
      font-size: 1rem; /* slightly larger icon */
      line-height: 1;
    }
    .btn-hear:hover{
      background: rgba(4,120,87,0.18);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(2,6,23,0.08);
    }

    /* Container styling for revealed feedback.  This box groups the
       correctness message, completed sentence, answer details and the
       audio button.  A soft tint and border help it stand apart from
       the rest of the card without drawing too much attention. */
    .feedback-box{
      background: rgba(4,120,87,0.05);
      border: 1px solid rgba(4,120,87,0.20);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1.5rem;
    }

    /* Toggle pill used in filter selectors */
    .pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      border-radius:999px;
      padding:.32rem .62rem;
      font-weight:650;
      font-size:10.5px;
      border:1px solid rgba(148,163,184,.28);
      background:rgba(255,255,255,.82);
      cursor:pointer;
    }
    .pill-on{
      background:rgba(4,120,87,.12);
      border-color:rgba(4,120,87,.26);
      box-shadow: inset 0 0 0 1px rgba(217,119,6,0.14);
    }

    /* --------- Theme overrides for Tailwind utilities used in JS output ---------
    */
    .bg-indigo-100{ background-color: rgba(4,120,87,0.12) !important; }
    .ring-indigo-300{ --tw-ring-color: rgba(4,120,87,0.30) !important; }
    .text-indigo-900{ color: var(--emerald-ink) !important; }

    .bg-indigo-50{ background-color: rgba(16,185,129,0.10) !important; }
    .ring-indigo-200{ --tw-ring-color: rgba(16,185,129,0.25) !important; }

    .bg-rose-50{ background-color: rgba(185,28,28,0.06) !important; }
    .ring-rose-200{ --tw-ring-color: rgba(185,28,28,0.22) !important; }
    .text-rose-900{ color: rgba(127,29,29,0.95) !important; }

    .decoration-indigo-400{ text-decoration-color: rgba(4,120,87,0.55) !important; }

    /* Make the base word a touch bigger (JS outputs it inside the emerald capsule) */
    #practiceCard .bg-indigo-100 span{
      font-size: clamp(2.55rem, 4.6vw, 3.55rem) !important;
      letter-spacing: -0.02em;
    }

    /* Practice: sentence row alignment + action spacing */
    #practiceCard .mt-2 > .flex.items-baseline{
      align-items: center !important;
    }
    #practiceCard .mt-2 > .flex.items-baseline span{
      line-height: 1.45;
    }
    /* Actions live immediately after the sentence row (row has class mt-2) */
    #practiceCard .mt-2 + .flex.flex-wrap.gap-2{
      /* Increase separation between the input/actions and the feedback */
      margin-top: 1.4rem !important;
      gap: 1rem !important;
    }

/* Answer box: very faint gold, emerald focus */
    #answerBox{
      background: rgba(217,119,6,0.08) !important;
      border-color: rgba(148,163,184,0.55) !important;
    }
    #answerBox::placeholder{ color: rgba(100,116,139,0.85); }
    #answerBox:focus{
      border-color: rgba(4,120,87,0.72) !important;
      box-shadow: 0 0 0 4px rgba(4,120,87,0.12) !important;
    }


    /* Header: clean, lightly glassy */
    #siteHeader{
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }

    /* Slightly tighter subtitle colour */
    .subtle{ color: var(--muted); }

    /* -------------------------
       2025-12 tweaks: make Practice card feel centred + stronger Cymru palette
       (CSS-only overrides; JS untouched)
    ------------------------- */

    /* Reduce gold in the page wash: keep it ultra-sparing */
    body{
      background-image:
        radial-gradient(900px 520px at 20% -10%, var(--page-tint), transparent 60%),
        radial-gradient(900px 560px at 95% 95%, rgba(185,28,28,0.025), transparent 60%),
        radial-gradient(900px 620px at 90% 0%, rgba(217,119,6,0.015), transparent 55%);
    }

    /* Centre the practice content within the big left panel so it doesn't feel "lost" */
    #practiceCard > div{
      max-width: 46rem;
      margin-inline: auto;
    }

    /* Card counter: make it feel designed (tiny caps + tracking) */
    #practiceCard .text-slate-500.text-xs.mb-2{
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    /* Base word capsule: centred focal point, slightly more intentional */
    #practiceCard .bg-indigo-100.ring-1.ring-indigo-300.rounded-2xl{
      display: flex !important;
      width: fit-content;
      margin: 0 auto;
      box-shadow:
        0 12px 26px rgba(2,6,23,0.08),
        inset 0 -2px 0 rgba(185,28,28,0.20);
    }

    /* Keep sentence alignment feeling "text-like" */
    #practiceCard .mt-2 > .flex.items-baseline{
      align-items: baseline !important;
    }

    /* Answer box: allow it to flex so long sentences wrap more naturally */
    #answerBox{
      width: clamp(10rem, 22vw, 16rem) !important;
      flex: 0 1 clamp(10rem, 22vw, 16rem) !important;
      flex-shrink: 1 !important;
      line-height: 1.15;
    }

    /* Give the action buttons a clearer "breath" from the sentence row */
    #practiceCard .mt-2 + .flex.flex-wrap.gap-2{
      margin-top: 1.45rem !important;
      gap: 1rem !important;
    }

    /* Active filter chips: red-tinted (echo the red bar) while staying subtle */
    .chip{
      background: rgba(185,28,28,0.055) !important;
      border-color: rgba(185,28,28,0.20) !important;
      color: rgba(15,23,42,0.88) !important;
    }

    /* Make the final "Clear" chip your main gold accent (sparingly used) */
    #practiceCard .flex.flex-wrap.items-center.gap-2.mb-4 .chip:last-child{
      background: rgba(217,119,6,0.085) !important;
      border-color: rgba(217,119,6,0.30) !important;
    }

    /* Gold should be rare: remove the gold-ish inner stroke from active filter pills */
    .pill-on{
      box-shadow: none !important;
    }

    /* -------------------------
       Polish pass: alignment + hover (CSS-only)
       Goal: green + red primary palette, gold only as a subtle accent (answer box / badges)
    ------------------------- */

    /* Base word capsule: true visual centring + calmer shadow */
    #practiceCard .bg-indigo-100.ring-1.ring-indigo-300.rounded-2xl{
      align-items:center !important;
      justify-content:center !important;
      padding-top: .9rem !important;
      padding-bottom: .9rem !important;
      box-shadow: 0 8px 18px rgba(2,6,23,0.08) !important;
    }
    #practiceCard .bg-indigo-100.ring-1.ring-indigo-300.rounded-2xl span{
      line-height: 1 !important;
      display: block !important;
      transform: translateY(0px);
    }

    /* Sentence â†’ actions: give the controls a clear "breath" and a subtle red divider */
    #practiceCard .mt-2 + .flex.flex-wrap.gap-2{
      margin-top: 1.55rem !important;
      padding-top: 1.05rem !important;
      gap: 1rem !important;
      border-top: 1px solid rgba(185,28,28,0.14);
    }

    /* Chips: keep active filters subtly red-tinted, but make CLEAR green */
    #practiceCard .flex.flex-wrap.items-center.gap-2.mb-4 .chip{ cursor: default; }
    #practiceCard .flex.flex-wrap.items-center.gap-2.mb-4 .chip:last-child{
      cursor: pointer;
      background: rgba(4,120,87,0.10) !important;
      border-color: rgba(4,120,87,0.28) !important;
      color: rgba(6,78,59,0.95) !important;
    }
    #practiceCard .flex.flex-wrap.items-center.gap-2.mb-4 .chip:last-child:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(2,6,23,0.07);
      filter: saturate(1.02) brightness(1.01);
    }

    /* Filter pills: add hover so they feel interactive */
    .pill{
      transition: transform .08s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .pill:hover{
      background: rgba(255,255,255,0.96);
      border-color: rgba(4,120,87,0.24);
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(2,6,23,0.07);
    }
    .pill:active{
      transform: translateY(0px);
      box-shadow: 0 6px 12px rgba(2,6,23,0.05);
    }
    .pill-on:hover{
      background: rgba(4,120,87,0.15);
      border-color: rgba(4,120,87,0.34);
    }

  

    /* -------------------------
       Layout tightening (fixes excess whitespace on desktop)
       - Stop grid rows stretching panels to 1fr heights
       - Keep Filters (row 1) and Session (row 2) stable
    ------------------------- */
    @media (min-width: 768px){
      #practiceView{
        grid-template-rows: auto auto !important;
        align-items: start !important;
      }
      #filtersPanel{
        grid-row: 1 / 2 !important;
        align-self: start !important;
      }
      #practiceView > aside{
        grid-row: 2 / 3 !important;
        align-self: start !important;
        height: fit-content;
      }
      /* Left practice panel */
      #practiceView > div:nth-child(1){
        align-self: start !important;
      }
    }
    /* -------------------------
       Practice layout polish (left-aligned copy, centred base word)
       - Keeps the header + filter chips left
       - Centres the base word capsule
       - Adds consistent breathing room before action buttons
    ------------------------- */

    /* Keep the content column a sensible width, but don't centre the text itself */
    #practiceCard > div{
      max-width: 46rem;
      margin-inline: auto;
    }

    /* Copy should read like copy: left aligned */
    #practiceCard .practice-instruction{
      text-align: left;
      text-wrap: pretty;
    }

    /* Base word capsule: centred focal point + calmer shadow */
    #practiceCard .practice-base{
      display:flex;
      justify-content:center;
      margin: .35rem 0 1.65rem;
    }
    #practiceCard .practice-base .bg-indigo-100.ring-1.ring-indigo-300.rounded-2xl{
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: .95rem 1.25rem !important;
      box-shadow: 0 8px 18px rgba(2,6,23,0.08) !important;
    }
    #practiceCard .practice-base .bg-indigo-100.ring-1.ring-indigo-300.rounded-2xl span{
      line-height: 1 !important;
      display:block;
    }

    /* Sentence line: keep it left aligned, but with a bit more air under the base word */
    #practiceCard .practice-sentence{
      margin-top: .25rem;
    }

    /* Buttons: clear separation + consistent spacing */
    #practiceCard .practice-actions{
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(185,28,28,0.14);
      justify-content: flex-start;
      gap: 1rem;
    }

    /* Remove any lingering centring from older CSS experiments */
    #practiceCard > div > div.text-lg.md\:text-xl.text-slate-700{ text-align:left !important; }
    #practiceCard > div > div.mt-2 > div.flex{ justify-content:flex-start !important; text-align:left !important; }
    #practiceCard .mt-2 + .flex.flex-wrap.gap-2{ justify-content:flex-start !important; }


    /* Header nav buttons: slightly lighter weight + clearer gradient hero */
    #siteHeader .btn{ font-weight: 600; }

    /* --- Header nav buttons: make Practice the hero, Stats/Filters secondary (red) --- */
    #btnStats, #btnFilters{
      padding: .5rem .9rem;
      border-radius: 999px;
      font-weight: 600;
      background: rgba(185,28,28,0.08);
      border-color: rgba(185,28,28,0.24);
      color: rgba(127,29,29,0.96);
    }
    #btnStats:hover, #btnFilters:hover{
      background: linear-gradient(to right, rgba(185,28,28,0.96), rgba(153,27,27,0.96));
      border-color: rgba(185,28,28,0.55);
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(2,6,23,0.14);
    }

    /* --- Filters: hide redundant Outcome column (JS untouched, state still applies) --- */
    #outcomeCol{ display:none; }
    #familyCol{ grid-column: 1 / -1; }

    /* --- Filters panel: stop it forcing huge page height on desktop --- */
    @media (min-width: 768px){
      #filtersPanel{
        max-height: calc(100vh - 190px);
        overflow: auto;
        overscroll-behavior: contain;
      }
      #filtersPanel::-webkit-scrollbar{ width: 10px; }
      #filtersPanel::-webkit-scrollbar-thumb{
        background: rgba(15,23,42,0.12);
        border-radius: 999px;
        border: 3px solid rgba(255,255,255,0.70);
      }
    }

    /* --- Practice sentence line: baseline can feel 'wonky' with the big input; centre it --- */
    #practiceCard .practice-sentenceLine{ align-items: center !important; }

    /* Slightly tighter right panels (reduces dead space) */
    #sessionPanel{ padding-bottom: 1.05rem !important; }



    /* -------------------------
       Final polish pass (alignment + palette cohesion)
       - Desktop: align the base word capsule with the left text edge
       - Mobile: keep the base word centred
       - Use a subtle Cymru greenâ†’red divider and header ribbon
    ------------------------- */

    /* Ribbon: match the exact inks used in the title */
    .cymru-red-bar{
      background: linear-gradient(90deg,
        rgba(6,78,59,0) 0%,
        rgba(6,78,59,1) 30%,
        rgba(153,27,27,1) 70%,
        rgba(153,27,27,0) 100%
      ) !important;
    }

    /* Instruction reads like copy, not a banner */
    #practiceCard .practice-instruction{
      max-width: 42rem;
      margin-bottom: 1.15rem !important;
    }

    /* Base word: centred on mobile, aligned on desktop */
    #practiceCard .practice-base{
      justify-content: center;
      margin: .8rem 0 2.35rem !important;
    }
    @media (min-width: 768px){
      #practiceCard .practice-base{ justify-content: flex-start; }
    }

    /* Base capsule: calm shadow, no weird baseline wobble */
    #practiceCard .practice-base .bg-indigo-100.ring-1.ring-indigo-300.rounded-2xl{
      box-shadow: 0 5px 12px rgba(2,6,23,0.06) !important;
    }

    /* Actions row: gradient divider instead of a plain rule */
    #practiceCard .practice-actions{
      position: relative;
      border-top: 0 !important;
      padding-top: 1.05rem !important;
      margin-top: 1.35rem !important;
    }
    #practiceCard .practice-actions::before{
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 1px;
      background: linear-gradient(90deg,
        rgba(6,78,59,0.24),
        rgba(153,27,27,0.24)
      );
    }

    /* Buttons: centred on mobile feels intentional, left on desktop */
    #practiceCard .practice-actions{ justify-content: center; }
    @media (min-width: 768px){
      #practiceCard .practice-actions{ justify-content: flex-start; }
    }



    /* --- Brand dot: tighter spacing + vertical centring (dot replaces the word-space) --- */
    .cymru-dot{
      width: 8px !important;
      height: 8px !important;
      margin: 0 .18rem !important; /* much tighter than before */
      background: var(--cymru-red-ink) !important; /* must match Treiglad */
      box-shadow: none !important;
      transform: translateY(-0.06em);
    }
    @media (min-width: 768px){
      .cymru-dot{
        width: 9px !important;
        height: 9px !important;
        margin: 0 .22rem !important;
      }
    }



    /* =========================
       2025-12-17 polish tweaks
       - Cleaner Cymru ribbon (no muddy mid-colour)
       - More obvious (but on-brand) green gradient on primary buttons
       - Tighter practice action buttons spacing
       ========================= */

    /* Keep primary button green closer to the Hyfforddwr title ink */
    :root{
      --primary-from: #0a6b52;
      --primary-mid:  #075a44;
      --primary-to:   #064e3b;
    }

    /* Ribbon: cleaner greenâ†’red (short transition, no transparent ends) */
    .cymru-red-bar{
      background: linear-gradient(90deg,
        rgba(6,78,59,1) 0%,
        rgba(6,78,59,1) 46%,
        rgba(153,27,27,1) 54%,
        rgba(153,27,27,1) 100%
      ) !important;
    }

/* Title: rely on colour change as the separator (no extra spacing) */
    .title-trei{ margin-left: 0 !important; }

    /* Primary button: make the gradient feel intentional (subtle motion on hover) */
    .btn-primary{
      background-size: 220% 220% !important;
      background-position: 0% 50% !important;
    }
    .btn-primary:hover{ background-position: 100% 50% !important; }

    /* Header nav: slightly lighter weight on secondary buttons */
    #btnStats, #btnFilters{ font-weight: 500 !important; }

    /* Filter pills: a touch smaller/tighter */
    .pill{
      padding: .28rem .56rem !important;
      font-size: 10px !important;
    }

    /* Practice actions row: reduce spacing + pull it slightly closer to the sentence */
    #practiceCard .practice-actions{
      margin-top: 1.05rem !important;
      padding-top: .75rem !important;
      gap: .65rem !important;
    }
    #practiceCard .practice-actions .btn{
      padding: .5rem .85rem !important;
    }

    /* Base word capsule: left-align (always) */
    #practiceCard .practice-base{
      justify-content: flex-start !important;
    }

</style>
</head>

<body class="min-h-screen text-slate-900">
  <div id="app" class="min-h-screen flex flex-col text-[16px] md:text-[17px]">

    <header id="siteHeader" class="sticky top-0 z-10">
      <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between md:gap-4">

        <div class="brand-lockup grow min-w-0">
          <img class="brand-dragon" alt="" aria-hidden="true" src="https://katyjohannab.github.io/welsh-mutation-trainer/images/dragon.png" />
          <h1 class="bbh-bogle-regular brand-title text-3xl md:text-4xl lg:text-5xl tracking-tight"><span class="title-hy">Hyfforddwr</span><span class="title-trei">Treiglad</span></h1>
        </div>

        <div class="flex flex-wrap items-center justify-start md:justify-end gap-2">
          <span id="itemCount" class="hidden ml-1 px-2.5 py-1 rounded-full text-xs bg-amber-50 text-amber-900 border border-amber-200/70">0 items</span>
          <span id="adminBadge" class="hidden ml-1 px-2.5 py-1 rounded-full text-xs bg-amber-50 text-amber-800 border border-amber-200/70">Admin</span>

          <button id="btnPractice" title="Practice" class="btn btn-primary">Practice</button>
          <button id="btnBrowse" title="Browse (table)" class="btn btn-ghost hidden">Browse</button>
          <button id="btnStats" title="Stats" class="btn btn-ghost">Stats</button>
          <button id="btnFilters" title="Filters (F)" class="btn btn-ghost">Filters</button>
          <button id="btnHelp" title="Help" class="btn btn-ghost hidden">Help</button>
        </div>

      </div>
      <div class="cymru-red-bar" aria-hidden="true"></div>
    </header>

    <!-- Onboarding -->
    <section id="onboard" class="max-w-6xl mx-auto p-4 mt-3">
      <div class="panel rounded-2xl p-4 flex items-start gap-3">
        <div class="text-2xl">ðŸ’¡</div>
        <div class="text-sm text-slate-700"><div class="font-medium mb-1">Welcome! How to use this trainer.</div><ol class="list-decimal ml-5 leading-relaxed"><li>Click <b>Filters</b> to pick what to practise (Prepositions, Numerals, Possessive, etc.).</li><li>Read the sentence and type the correct form in the box.</li><li>Press <b>Check</b> to mark your answer.</li><li>Read the <b>Why</b> explanation, then click <b>Next</b>.</li></ol>
          <div class="mt-3 flex gap-2">
            <button id="onboardFilters" class="btn btn-primary shadow">Open filters</button>
            <button id="onboardDismiss" class="btn btn-ghost">Got it</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Main panels -->
    <main id="main" class="grow max-w-6xl mx-auto p-4 pb-24 md:pb-4">
      <div id="practiceView" class="grid md:grid-cols-3 gap-4 items-start">
        <!-- Left: practice card -->
        <div class="md:col-span-2 panel rounded-2xl p-6 md:p-7">
          <div id="practiceCard"></div>
        </div>

        <!-- Right: filters + session (stacked so layout never "jumps" when filters are hidden) -->
        <div class="md:col-span-1 flex flex-col gap-4">
          <!-- Filter controls (hidden by default; toggled via Filters button) -->
          <div id="filtersPanel" class="panel rounded-2xl p-4 hidden">
            <!-- Admin / Data panel: only visible when admin=1 -->
            <div id="adminPanel" class="hidden mb-4">
              <div class="text-sm font-medium mb-2">Admin tools</div>
              <label class="text-sm font-medium">Data URL (CSV or JSON)</label>
              <div class="mt-2 flex gap-2">
                <input id="dataUrl" class="w-full border rounded-xl px-3 py-2" placeholder="Paste Google Sheet CSV (Publish â†’ CSV)">
                <button id="btnLoadUrl" class="btn btn-primary px-4 py-2">LOAD</button>
              </div>
              <div class="mt-2 flex flex-wrap gap-2 text-sm">
                <button id="btnShareable" class="btn btn-ghost px-3 py-1.5">Shareable link</button>
                <button id="btnExportMisses" class="btn btn-ghost px-3 py-1.5">Export misses</button>
              </div>
              <div class="mt-3">
                <div class="text-sm font-medium mb-1">Load local CSV</div>
                <input id="fileCsv" type="file" accept=".csv" />
              </div>
              <hr class="my-4" />
            </div>
            <!-- Focus filters -->
            <div class="text-sm font-medium mb-2">Focus</div>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div id="familyCol">
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">RuleFamily</div>
                <div id="familyBtns" class="flex flex-wrap gap-1"></div>
              </div>
              <div id="outcomeCol">
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Outcome</div>
                <div id="outcomeBtns" class="flex flex-wrap gap-1"></div>
              </div>
              <div class="col-span-2">
                <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Categories</div>
                <div id="catBtns" class="flex flex-wrap gap-1"></div>
              </div>
              <div class="col-span-2">
                <label class="text-xs uppercase tracking-wide text-slate-500">Filter by Trigger</label>
                <input id="triggerFilter" class="mt-1 w-full border rounded-xl px-3 py-1.5" placeholder="e.g. i, o, dwy, tri, y (article), neu" />
              </div>
              <label class="col-span-2 inline-flex items-center gap-2 text-sm mt-1">
                <input id="nilOnly" type="checkbox" />
                Nilâ€‘cases only (no mutation expected)
              </label>
            </div>
          </div>

          <!-- Session / stats panel -->
          <aside id="sessionPanel" class="panel rounded-2xl p-4">
            <div class="text-sm font-medium mb-2">Session</div>
            <div id="accBig" class="text-5xl md:text-6xl font-semibold">0%</div>
            <div id="accText" class="text-sm text-slate-600">0 / 0 correct</div>
            <div id="cardPos" class="text-sm text-slate-600">Card 0 / 0</div>
            <div class="mt-2 text-sm">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">By outcome</div>
              <ul id="byOutcome" class="space-y-1"></ul>
              <div class="mt-2 text-xs text-slate-500">Legend: <b>SM</b>=Soft, <b>AM</b>=Aspirate, <b>NM</b>=Nasal, <b>NONE</b>=No mutation</div>
            </div>
            <div class="mt-3 flex gap-2">
              <button id="btnResetStats" class="btn btn-ghost px-3 py-1.5">Reset stats</button>
            </div>
          </aside>
        </div>
      </div>

      <div id="browseView" class="hidden panel rounded-2xl overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr id="browseHead"></tr>
          </thead>
          <tbody id="browseBody"></tbody>
        </table>
      </div>

      <div id="statsView" class="hidden grid md:grid-cols-2 gap-4">
        <div class="panel rounded-2xl p-6">
          <h2 class="text-lg font-medium mb-2">Accuracy</h2>
          <div id="statsAcc" class="text-5xl font-bold">0%</div>
          <div id="statsText" class="text-slate-600">0 correct out of 0</div>
          <button id="btnResetStats2" class="mt-4 btn btn-ghost px-3 py-1.5">Reset</button>
        </div>
        <div class="panel rounded-2xl p-6">
          <h2 class="text-lg font-medium mb-2">By outcome</h2>
          <ul id="statsByOutcome" class="space-y-1 text-sm"></ul>
        </div>
      </div>
    </main>

    <!-- Mobile action bar -->
    <div id="mobileBar" class="fixed md:hidden bottom-0 inset-x-0 bg-white/95 backdrop-blur border-t shadow-lg p-2">
      <div class="max-w-6xl mx-auto flex gap-2">
        <button id="mbHint" title="Hint (H)" class="flex-1 btn btn-ghost px-3 py-2">Hint</button>
        <button id="mbCheck" title="Check (Enter)" class="flex-1 btn btn-primary px-3 py-2">Check</button>
        <button id="mbNext" title="Next (Enter)" class="flex-1 btn btn-ghost px-3 py-2">Next</button>
      </div>
    </div>

    <footer class="max-w-6xl mx-auto p-6 text-xs text-slate-500">
      <div class="flex flex-wrap gap-4 items-center">
        <span>Â© Welsh Mutation Trainer</span>
        <span>Data columns: RuleFamily Â· RuleCategory Â· Trigger Â· Base Â· WordCategory Â· Before Â· After Â· Answer Â· Outcome Â· Why</span>
        <button id="btnTop" class="ml-auto btn btn-ghost px-2 py-1">Back to top</button>
      </div>
    </footer>
  </div>

  <script>
  // ---------- Utilities ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function normalize(s){
    return (s||"").toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/â€™/g,"'").toLowerCase().trim().replace(/\s+/g,' ');
  }
  function esc(s){ return (s==null?'' : String(s)).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }
  function download(text, filename, type='text/plain'){
    const blob = new Blob([text], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
  }
  function getParam(k){ return new URLSearchParams(location.search).get(k); }

  function saveLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  function loadLS(k, d){ try{ const r = localStorage.getItem(k); return r? JSON.parse(r): d; }catch(e){ return d; } }

  // ---------- Data coercion ----------
  const PREP = new Set(["am","ar","at","dan","dros","tros","drwy","trwy","gan","heb","hyd","i","o","tan","wrth","yng","yn","gyda","hefo","Ã¢"]);
  function getVal(row, names){
    const keys = Object.keys(row || {});
    for (const key of keys){
      if (names.some(n => key.trim().toLowerCase() === n.trim().toLowerCase())){
        return (row[key] ?? "").toString().trim();
      }
    }
    return "";
  }
  function familyFromOutcome(outcome){
    const o = (outcome||"").toUpperCase();
    if (o==='SM') return 'Soft';
    if (o==='AM') return 'Aspirate';
    if (o==='NM') return 'Nasal';
    if (o==='NONE') return 'None';
    return '';
  }
  function coerceRow(row){
    const r = row || {};
    const rawOutcome = getVal(r, ["Outcome","Result","Mutation","Mut"]);
    const o = (rawOutcome || '').replace(/["']/g, '').toUpperCase();
    const trig = getVal(r, ["Trigger","Trigger/Structure","Structure","Preposition"]);
    let famRaw = getVal(r, ["RuleFamily","Rule Family","Family"]).trim();
    if (!famRaw) famRaw = familyFromOutcome(o);
    let fam = famRaw;
    if (famRaw.includes(',')) {
      fam = famRaw.split(',')[0].trim();
    }
    return {
      RuleFamily: fam,
      RuleCategory: getVal(r, ["RuleCategory","Rule Category","Category"]) || (PREP.has((trig||'').toLowerCase()) ? 'Preposition' : ''),
      Trigger: trig,
      Base: getVal(r, ["Base","Radical","Word","Base word","BaseWord"]),
      WordCategory: getVal(r, ["WordCategory","Word Category","POS","Part of speech"]),
      Before: getVal(r, ["Before","PromptBefore","Left","SentenceBefore"]),
      After: getVal(r, ["After","PromptAfter","Right","SentenceAfter"]),
      Answer: getVal(r, ["Answer","Expected","Mutated","Target"]),
      Outcome: o,
      Why: getVal(r, ["Why","Note","Rule","Explanation","Notes"])
    };
  }

  // ---------- App State ----------
  const state = {
    rows: [],
    filtered: [],
    families: loadLS('wm_families',["Soft","Aspirate","Nasal","None"]),
    categories: loadLS('wm_categories',[]),
    outcomes: loadLS('wm_outcomes',["SM","AM","NM","NONE"]),
    triggerQuery: loadLS('wm_trig',''),
    nilOnly: loadLS('wm_nil', false),
    mode: loadLS('wm_mode','practice'),
    deck: [],
    p: 0,
    guess: '',
    revealed: false,
    lastResult: null,
    history: loadLS('wm_hist',[]),
    admin: getParam('admin') === '1',
    freezeIdx: null,
    freezePos: null
  };

  // ---------- Data loading ----------
// Loads ONLY the sources listed in data/index.json (e.g. ["data/cards.csv"]).
// In GitHub Pages this works via relative paths. In canvas preview, relative fetches may not resolve,
// so we also try your live URLs as a fallback (NOT a demo dataset).

const FALLBACK_INDEX_URL = 'https://katyjohannab.github.io/welsh-mutation-trainer/data/index.json';
const FALLBACK_SITE_ROOT = 'https://katyjohannab.github.io/welsh-mutation-trainer/';

async function loadCsvUrl(u){
  return new Promise((resolve, reject) => {
    Papa.parse(u, {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: (res) => resolve(res.data),
      error: reject
    });
  });
}

function isAbsUrl(u){ return /^https?:\/\//i.test(u || ''); }
function resolveFromRoot(path, root){
  const p = (path || '').toString().trim();
  if (!p) return '';
  if (isAbsUrl(p)) return p;
  // treat entries like "data/cards.csv" as site-root relative
  return new URL(p.replace(/^\/+/, ''), root).toString();
}

async function fetchIndexList(url){
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error('Failed to fetch index: ' + url);
  const j = await r.json();
  if (!Array.isArray(j)) throw new Error('Index JSON is not an array: ' + url);
  return j;
}

async function loadAllDefault(){
  let list = null;
  let usingFallbackRoot = false;

  // Try local relative first (works on your deployed site)
  try{
    list = await fetchIndexList('data/index.json');
  }catch(e){
    // Canvas preview often needs absolute
    try{
      list = await fetchIndexList(FALLBACK_INDEX_URL);
      usingFallbackRoot = true;
    }catch(e2){
      console.warn('Failed to load both local and fallback index.json', e, e2);
      return [];
    }
  }

  const root = usingFallbackRoot ? FALLBACK_SITE_ROOT : new URL('.', location.href).toString();
  let merged = [];
  for (const p of list){
    const url = resolveFromRoot(p, root);
    if (!url) continue;
    try{
      const d = await loadCsvUrl(url);
      merged = merged.concat(d);
    }catch(err){
      console.warn('Failed to load source:', url, err);
    }
  }
  return merged;
}

async function initData(){

    const sheet = getParam('sheet');
    let rows = [];
    try{
      if (sheet){ rows = await loadCsvUrl(sheet); }
      else { rows = await loadAllDefault(); }
    }catch(e){ console.warn('Data load failed; no demo fallback configured.', e); rows = await loadAllDefault(); }
    const expected = ["RuleFamily","RuleCategory","Trigger","Base","WordCategory","Before","After","Answer","Outcome","Why"];
    const cleaned = rows.map(r => {
      const m = coerceRow(r); const o = {};
      for (const k of expected) o[k] = (m?.[k] ?? '').toString().trim();
      return o;
    });
    state.rows = cleaned;
    $('#itemCount').textContent = `${state.rows.length} items`;
    applyFilters();
    rebuildDeck();
    buildFilters();
    render();
  }

  // ---------- Filters & Deck ----------
  function buildFilters(){
    const fams = new Set(); const cats = new Set();
    for (const r of state.rows){ if (r.RuleFamily) fams.add(r.RuleFamily); if (r.RuleCategory) cats.add(r.RuleCategory); }
    const outcomes = ["SM","AM","NM","NONE"];

    const qs = $('#qs');
    if (qs) {
      qs.innerHTML = '';
      qs.classList.add('hidden');
    }

    const famEl = $('#familyBtns'); famEl.innerHTML='';
    for (const f of ["Soft","Aspirate","Nasal","None"]) {
      famEl.appendChild(toggleBtn(f, state.families.includes(f), (on)=>{
        state.families = on? Array.from(new Set([...state.families, f])) : state.families.filter(x=>x!==f);
        saveLS('wm_families',state.families); applyFilters(); rebuildDeck(); buildFilters(); render();
      }));
    }

    const outEl = $('#outcomeBtns');
    outEl.innerHTML = '';
    const outcomeCounts = {};
    state.filtered.forEach(r => {
      const o = (r.Outcome || '').toUpperCase();
      if (!o) return;
      outcomeCounts[o] = (outcomeCounts[o] || 0) + 1;
    });
    for (const o of outcomes) {
      const count = outcomeCounts[o] || 0;
      const label = `${o} (${count})`;
      outEl.appendChild(
        toggleBtn(label, state.outcomes.includes(o), (on) => {
          state.outcomes = on
            ? Array.from(new Set([...state.outcomes, o]))
            : state.outcomes.filter((x) => x !== o);
          saveLS('wm_outcomes', state.outcomes);
          applyFilters();
          rebuildDeck();
          buildFilters();
          render();
        })
      );
    }

    const catEl = $('#catBtns');
    catEl.innerHTML = '';
    const allCatsActive = !state.categories.length;
    catEl.appendChild(
      toggleBtn(
        'All',
        allCatsActive,
        (on) => {
          if (on) {
            state.categories = [];
          } else {
            state.categories = [];
          }
          saveLS('wm_categories', state.categories);
          applyFilters();
          rebuildDeck();
          buildFilters();
          render();
        }
      )
    );
    for (const c of Array.from(cats).sort()) {
      const active = state.categories.includes(c);
      catEl.appendChild(
        toggleBtn(c, active, (on) => {
          state.categories = on
            ? Array.from(new Set([...state.categories, c]))
            : state.categories.filter((x) => x !== c);
          saveLS('wm_categories', state.categories);
          applyFilters();
          rebuildDeck();
          buildFilters();
          render();
        })
      );
    }

    $('#triggerFilter').value = state.triggerQuery;
    $('#triggerFilter').oninput = (e)=>{ state.triggerQuery = e.target.value; saveLS('wm_trig',state.triggerQuery); applyFilters(); rebuildDeck(); buildFilters(); render(); };
    $('#nilOnly').checked = !!state.nilOnly;
    $('#nilOnly').onchange = (e)=>{ state.nilOnly = e.target.checked; saveLS('wm_nil',state.nilOnly); applyFilters(); rebuildDeck(); buildFilters(); render(); };
  }

  function applyFilters(){
    const allowedOutcomes = state.outcomes && state.outcomes.length ? state.outcomes : ['SM','AM','NM','NONE'];
    let list = state.rows.filter(r =>
      (state.families.length ? state.families.includes(r.RuleFamily) : true) &&
      (state.categories.length ? state.categories.includes(r.RuleCategory) : true) &&
      (allowedOutcomes.includes((r.Outcome||'').toUpperCase()))
    );
    if (state.nilOnly) list = list.filter(r => (r.Outcome||'').toUpperCase()==='NONE');
    if ((state.triggerQuery||'').trim()){
      const q = normalize(state.triggerQuery);
      list = list.filter(r => normalize(r.Trigger).includes(q));
    }
    state.filtered = list;
  }

  function rebuildDeck(){
    const n = state.filtered.length; const d = Array.from({length:n}, (_,i)=>i);
    for (let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; }
    state.deck = d; state.p = 0; state.guess=''; state.revealed=false; state.lastResult=null;
    state.freezeIdx = null; state.freezePos = null;
  }

//build Sentence
function buildCompleteSentence(card) {
  const before = (card.Before || '').trimEnd();
  const answer = (card.Answer || '').trim();
  const after  = (card.After  || '').trimStart();

  let s = [before, answer, after].filter(Boolean).join(' ');
  s = s.replace(/\s+/g, ' ').trim();
  s = s.replace(/\s+([,.;:!?])/g, '$1'); // remove space before punctuation
  return s;
}

// ---------- TTS (Amazon Polly via your Lambda Function URL) ----------
// PUT YOUR REAL FUNCTION URL HERE:
// The user has provided their deployed Amazon Polly Lambda function URL.
// Use this value to call the TTS service.
const POLLY_FUNCTION_URL = "https://pl6xqfeht2hhbruzlhm3imcpya0upied.lambda-url.eu-west-2.on.aws/";

// Cache MP3 blobs in-memory so repeated clicks don't keep calling AWS
const ttsCache = new Map();

//build Sentence
function buildCompleteSentence(card) {
  const before = (card.Before || '').trimEnd();
  const answer = (card.Answer || '').trim();
  const after  = (card.After  || '').trimStart();

  let s = [before, answer, after].filter(Boolean).join(' ');
  s = s.replace(/\s+/g, ' ').trim();
  s = s.replace(/\s+([,.;:!?])/g, '$1'); // remove space before punctuation
  return s;
}

async function playPollySentence(sentence) {
  if (!sentence) throw new Error("No sentence to speak.");
  if (!POLLY_FUNCTION_URL || POLLY_FUNCTION_URL.includes("PASTE_YOUR_LAMBDA_FUNCTION_URL_HERE")) {
    throw new Error("POLLY_FUNCTION_URL isn't set. Paste your Lambda Function URL into the script.");
  }

  // Use cache if already generated this exact sentence
  const cachedUrl = ttsCache.get(sentence);
  if (cachedUrl) {
    const audio = new Audio(cachedUrl);
    await audio.play();
    return;
  }

  const res = await fetch(POLLY_FUNCTION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: sentence })
  });

  if (!res.ok) {
    const msg = await res.text().catch(() => "");
    throw new Error(msg || `TTS failed (${res.status})`);
  }

  // Be tolerant: Lambda might return raw MP3 bytes OR JSON with base64
  const ct = (res.headers.get("content-type") || "").toLowerCase();

  let url = null;

  if (ct.includes("audio") || ct.includes("octet-stream")) {
    const buf = await res.arrayBuffer();
    const blob = new Blob([buf], { type: "audio/mpeg" });
    url = URL.createObjectURL(blob);
  } else {
    // JSON fallback: expects { audioBase64: "..."} or { audioContent: "..."} or { url: "..." }
    const j = await res.json();
    if (j.url) {
      url = j.url;
    } else if (j.audioBase64 || j.audioContent) {
      const b64 = j.audioBase64 || j.audioContent;
      const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const blob = new Blob([bytes], { type: "audio/mpeg" });
      url = URL.createObjectURL(blob);
    } else {
      throw new Error("TTS response wasn't audio and didn't include url/audioBase64/audioContent.");
    }
  }

  ttsCache.set(sentence, url);

  const audio = new Audio(url);
  await audio.play();
}



  // ---------- Render ----------
  function btn(label, extraClass, onClick){
    const b = document.createElement('button');
    b.className = `btn ${extraClass}`; b.textContent = label; b.onclick = onClick; return b;
  }

  function toggleBtn(label, active, onToggle){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = `pill ${active ? 'pill-on' : ''}`;
    b.textContent = label;
    b.onclick = ()=> onToggle(!active);
    return b;
  }

  function renderPractice(){
    const host = $('#practiceCard'); host.innerHTML='';
    const n = state.filtered.length;
    if (!n){ host.innerHTML = `<div class="text-slate-700 panel rounded-xl p-4">No cards match your filters. <button id="btnClearFilters" class="ml-2 btn btn-ghost px-2 py-1">Clear filters</button></div>`;
      const cf = document.getElementById('btnClearFilters'); if (cf){ cf.addEventListener('click', ()=>{
        state.families = ["Soft","Aspirate","Nasal","None"]; state.categories = []; state.outcomes = ["SM","AM","NM","NONE"]; state.triggerQuery = ''; state.nilOnly = false;
        saveLS('wm_families',state.families); saveLS('wm_categories',state.categories); saveLS('wm_outcomes',state.outcomes); saveLS('wm_trig',state.triggerQuery); saveLS('wm_nil',state.nilOnly);
        buildFilters(); applyFilters(); rebuildDeck(); render();
      }); }
      return; }
    const deckIdx = state.p % state.deck.length;
    const idxNow = state.deck[deckIdx];
    const idx = (state.revealed && state.freezeIdx != null) ? state.freezeIdx : idxNow;
    const card = state.filtered[idx];
    state.currentIdx = idxNow;
    state.currentDeckPos = deckIdx;
    $('#cardPos').textContent = `Card ${state.deck.length? (state.p % state.deck.length)+1 : 0} / ${state.deck.length || 0}`;
    const wrap = document.createElement('div');
    const header = document.createElement('div'); header.className='text-slate-500 text-xs mb-2';
    header.textContent = `Card ${state.deck.length? (state.p % state.deck.length)+1 : 0} / ${state.deck.length || 0}`;
    // Active filters summary as chips
    const summary = document.createElement('div');
    summary.className = 'flex flex-wrap items-center gap-2 mb-4';
    const addChip = (label, onClear) => {
      const c = document.createElement('button');
      c.type = 'button';
      c.className = 'chip';
      c.innerHTML = `<span>${esc(label)}</span>`;
      if (onClear) {
        const x = document.createElement('span');
        x.className = 'ml-1';
        x.textContent = 'âœ•';
        c.appendChild(x);
        c.onclick = onClear;
      }
      return c;
    };

    
    // families
    if (state.families.length && state.families.length < 4) {
      state.families.forEach(f => summary.appendChild(addChip(f)));
    } else {
      summary.appendChild(addChip('All families'));
    }
    // outcomes
    if (state.outcomes.length && state.outcomes.length < 4) {
      state.outcomes.forEach(o => summary.appendChild(addChip(o)));
    }
    // categories
    if (state.categories.length) {
      state.categories.forEach(ca => summary.appendChild(addChip(ca)));
    }
    // trigger
    if (state.triggerQuery && state.triggerQuery.trim()) {
      summary.appendChild(addChip(`Trigger: ${state.triggerQuery}`));
    }
    // nil only
    if (state.nilOnly) {
      summary.appendChild(addChip('Nil only'));
    }
    // Clear all chip
    summary.appendChild(addChip('Clear', () => {
      state.families = ["Soft","Aspirate","Nasal","None"];
      state.categories = [];
      state.outcomes = ["SM","AM","NM","NONE"];
      state.triggerQuery = '';
      state.nilOnly = false;
      saveLS('wm_families', state.families); saveLS('wm_categories', state.categories); saveLS('wm_outcomes', state.outcomes); saveLS('wm_trig', state.triggerQuery); saveLS('wm_nil', state.nilOnly);
      applyFilters(); rebuildDeck(); buildFilters(); render();
    }));
    const chips = document.createElement('div'); chips.className = 'practice-base text-2xl md:text-3xl font-medium';
    chips.innerHTML = `<div class="inline-flex items-baseline bg-indigo-100 ring-1 ring-indigo-300 rounded-2xl px-5 py-2.5 shadow-sm"><span class="text-indigo-900 text-3xl md:text-4xl font-bold tracking-tight">${esc(card.Base||'â€”')}</span></div>`;
    const instruction = document.createElement('div'); instruction.className='practice-instruction text-lg md:text-xl text-slate-700 mb-6';
    instruction.innerHTML = `Type the correct form. If no change is needed, repeat the base form.`;
    const row = document.createElement('div');
    row.className = 'practice-sentence mt-2';
    row.innerHTML = `
      <div class="practice-sentenceLine flex flex-wrap items-baseline gap-2 text-xl md:text-2xl">
        <span class="text-slate-600">${esc(card.Before || '')}</span>
        <input id="answerBox" class="border-2 border-slate-300 focus:border-cyan-600 outline-none bg-amber-50 px-3 py-2 rounded-xl text-2xl md:text-3xl leading-tight shadow-sm w-auto md:w-60 flex-shrink-0" placeholder="Answer" aria-label="Answer" />
        <span class="text-slate-600">${esc(card.After || '')}</span>
      </div>
    `;
    const actions = document.createElement('div'); actions.className='practice-actions flex flex-wrap gap-3';
    const btnCheck = btn('Check','btn-primary shadow', onCheck); btnCheck.id='btnCheck'; btnCheck.title='Check (Enter)';
    const btnHint  = btn('Hint','btn-ghost', ()=>{ hint.classList.toggle('hidden'); $('#answerBox').focus(); }); btnHint.id='btnHint'; btnHint.title='Hint (H)';
    const btnReveal= btn('Reveal','btn-ghost', ()=>{ state.revealed = !state.revealed; render(); });
    const btnSkip  = btn('Skip','btn-ghost', ()=>{
      // Reveal the answer instead of jumping away, so we have a full sentence to speak.
      state.guess = '';
      state.revealed = true;
      state.lastResult = 'skipped';
      state.freezeIdx = state.currentIdx;
      state.freezePos = state.currentDeckPos;
    
      // Disable input like Check does (so it feels consistent)
      const ab2 = document.getElementById('answerBox');
      if (ab2){
        ab2.disabled = true;
        ab2.classList.add('opacity-70','cursor-not-allowed');
      }
    
      render();
    });
    actions.append(btnCheck, btnHint, btnReveal, btnSkip);
    const hint = document.createElement('div'); hint.className='hidden mt-3 text-sm text-slate-600';
    hint.innerHTML = `Hint: starts with <b>${(card.Answer||'').slice(0,1) || '?'}</b>`;
    const feedback = document.createElement('div'); feedback.setAttribute('aria-live','polite');
    let btnHear = null;
    if (state.revealed){
      const ok = state.lastResult === 'correct';
      const skipped = state.lastResult === 'skipped';
      
      const statusIcon = skipped ? 'â­ï¸' : (ok ? 'âœ…' : 'âŒ');
      const statusColor = skipped ? 'text-slate-800' : (ok ? 'text-indigo-900' : 'text-rose-900');
      // Build the revealed feedback section.  The sentence, answer details
      // and audio button are grouped inside a soft-tinted box.  The
      // audio button uses an inline icon for clarity and has been
      // intentionally minimised in size.  Additional vertical spacing
      // separates the action buttons from the feedback container.
      feedback.innerHTML = `
        <div class="feedback-box">
          <div class="flex items-center gap-2 ${statusColor} text-2xl md:text-3xl font-semibold">
            ${statusIcon} ${skipped ? 'Skipped' : (ok ? 'Correct!' : 'Not quite')}
          </div>
          ${(!ok && !skipped)
            ? `<div class="mt-1 text-slate-700">You typed: <b>${esc(state.guess) || '(blank)'}</b></div>`
            : ''
          }
          <!-- Completed sentence with inline audio button -->
          <div class="mt-4 text-slate-800 text-xl md:text-2xl flex items-center flex-wrap gap-3">
            <span>${esc(card.Before || '')}</span>
            <span class="font-semibold underline decoration-indigo-400">${esc(card.Answer)}</span>
            <span>${esc(card.After || '')}</span>
            <button id="btnHear" class="btn-hear" type="button">
              <span class="icon" aria-hidden="true">&#128266;</span>
              <span> Hear</span>
            </button>
          </div>
          <!-- Answer details with consistent spacing -->
          <div class="mt-4 space-y-1 text-slate-700">
            <div>Answer: <b>${esc(card.Answer)}</b></div>
            <div>Trigger: <b>${esc(card.Trigger || 'â€”')}</b></div>
            <div><span class="font-medium">Rule:</span> ${esc(card.RuleCategory || 'â€”')} â€¢ ${(card.Outcome || '').toUpperCase()}</div>
            ${card.Why ? `<p class="mt-1">${esc(card.Why)}</p>` : ''}
          </div>
        </div>
      `;

      // Wire up the "Hear this" button (only exists when revealed)
        setTimeout(() => {
          const hearBtn = document.getElementById('btnHear');
          if (!hearBtn) return;
        
          hearBtn.onclick = async () => {
            try {
              // Always read the correct sentence (Before + correct Answer + After)
              const sentence = buildCompleteSentence({
                Before: card.Before,
                Answer: card.Answer,
                After: card.After
              });
              await playPollySentence(sentence);
            } catch (e) {
              alert("Couldn't play audio: " + (e?.message || e));
            }
          };
        }, 0);
      const nb = document.createElement('button');
      nb.id = 'inlineNext';
      nb.className = 'mt-3 btn btn-primary shadow transition'; nb.title='Next (Enter)';
      nb.textContent = 'Next';
      nb.onclick = ()=> nextCard(1);
      feedback.appendChild(nb);
    }
    wrap.append(header, summary, instruction, chips, row, actions, hint, feedback);
    host.appendChild(wrap);
    const ab = $('#answerBox');
    ab.value = state.guess; ab.focus();
    ab.addEventListener('keydown', (e)=>{ if (e.key==='Enter') { e.preventDefault(); e.stopPropagation(); onCheck(); } });
    ab.addEventListener('input', (e)=>{ state.guess = e.target.value; });
    function onCheck(){
      const ok = normalize(state.guess) === normalize(card.Answer);
      state.revealed = true; state.lastResult = ok? 'correct':'wrong';
      state.freezeIdx = state.currentIdx;
      state.freezePos = state.currentDeckPos;
      const rec = { t: Date.now(), ok, key: `${card.RuleCategory}:${card.Trigger}:${card.Base}`, expected: card.Answer, got: state.guess };
      state.history = [rec, ...state.history].slice(0, 500); saveLS('wm_hist', state.history);
      const ab2 = document.getElementById('answerBox'); if (ab2){ ab2.disabled = true; ab2.classList.add('opacity-70','cursor-not-allowed'); }
      setTimeout(()=> document.getElementById('inlineNext')?.focus(), 0);
      render();
    }
  }

  function renderBrowse(){
    const head = $('#browseHead'); const body = $('#browseBody');
    head.innerHTML = ''; body.innerHTML = '';
    const cols = ["RuleFamily","RuleCategory","Trigger","Base","WordCategory","Before","After","Answer","Outcome","Why"];
    for (const h of cols){ const th = document.createElement('th'); th.className='text-left p-2 border-b'; th.textContent = h; head.appendChild(th); }
    state.filtered.forEach((r,i)=>{
      const tr = document.createElement('tr'); tr.className = (i%2? 'bg-white':'bg-slate-50');
      for (const k of cols){ const td = document.createElement('td'); td.className='p-2 align-top'; td.textContent = (k==='Outcome'? (r[k]||'').toUpperCase(): r[k]); if (k==='Answer') td.classList.add('font-semibold'); if (k==='Why') td.classList.add('text-slate-600'); tr.appendChild(td); }
      body.appendChild(tr);
    });
  }

  function computeStats(){
    const total = state.history.length; const correct = state.history.filter(h=>h.ok).length;
    const acc = total? Math.round((correct/total)*100) : 0;
    const by = {};
    for (const h of state.history){
      const r = state.rows.find(r => `${r.RuleCategory}:${r.Trigger}:${r.Base}`===h.key); const out = (r?.Outcome||'?').toUpperCase();
      by[out] = by[out] || { total:0, ok:0 }; by[out].total++; if (h.ok) by[out].ok++;
    }
    return { total, correct, acc, by };
  }

  function renderStatsPanels(){
    const s = computeStats();
    $('#accBig').textContent = `${s.acc}%`;
    $('#accText').textContent = `${s.correct} / ${s.total} correct`;
    $('#statsAcc').textContent = `${s.acc}%`;
    $('#statsText').textContent = `${s.correct} correct out of ${s.total}`;
    const ul1 = $('#byOutcome'); ul1.innerHTML='';
    const ul2 = $('#statsByOutcome'); ul2.innerHTML='';
    for (const [k,v] of Object.entries(s.by)){
      const li1 = document.createElement('li'); li1.className='flex justify-between'; li1.innerHTML = `<span>${k}</span><span class="text-slate-600">${v.ok}/${v.total}</span>`; ul1.appendChild(li1);
      const li2 = document.createElement('li'); li2.className='flex justify-between'; li2.innerHTML = `<span>${k}</span><span class="text-slate-600">${v.ok}/${v.total}</span>`; ul2.appendChild(li2);
    }
  }

  function render(){
    $('#practiceView').classList.toggle('hidden', state.mode!=='practice');
    $('#browseView').classList.toggle('hidden', state.mode!=='browse');
    $('#statsView').classList.toggle('hidden', state.mode!=='stats');
    renderPractice();
    if (state.mode==='browse') renderBrowse();
    renderStatsPanels();
  }

  function nextCard(offset=1){
    if (!state.deck.length) return;
    if (state.lastResult === 'wrong' && state.freezeIdx != null && state.freezePos != null){
      const idxVal = state.freezeIdx;
      let deckPos = state.freezePos;
      if (state.deck[deckPos] !== idxVal){
        deckPos = state.deck.indexOf(idxVal);
      }
      if (deckPos >= 0){
        const newDeck = state.deck.slice();
        newDeck.splice(deckPos, 1);
        const insertAt = Math.min(deckPos + 3, newDeck.length);
        newDeck.splice(insertAt, 0, idxVal);
        state.deck = newDeck;
      }
    }
    state.freezeIdx = null; state.freezePos = null;
    state.p = (state.p + offset + state.deck.length) % state.deck.length;
    state.guess=''; state.revealed=false; state.lastResult=null;
    render();
  }

  // ---------- Event wiring ----------
  function wireUi(){
    $('#btnPractice').onclick = ()=>{ state.mode='practice'; saveLS('wm_mode',state.mode); render(); };
    $('#btnBrowse').onclick   = ()=>{ state.mode='browse';   saveLS('wm_mode',state.mode); render(); };
    $('#btnStats').onclick    = ()=>{ state.mode='stats';    saveLS('wm_mode',state.mode); render(); };
    $('#btnFilters').onclick  = ()=>{ $('#filtersPanel')?.classList.toggle('hidden'); };
    $('#btnHelp').onclick     = ()=>{ $('#onboard')?.classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); };
    $('#onboardFilters')?.addEventListener('click', () => {
      const onboard = $('#onboard');
      if (onboard) onboard.classList.add('hidden');
      $('#filtersPanel')?.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    $('#onboardDismiss')?.addEventListener('click', () => {
      const onboard = $('#onboard');
      if (onboard) onboard.classList.add('hidden');
    });
    $('#btnResetStats').onclick = $('#btnResetStats2').onclick = ()=>{ state.history=[]; saveLS('wm_hist',state.history); render(); };
    $('#btnTop').onclick = ()=> window.scrollTo({top:0, behavior:'smooth'});
    document.addEventListener('keydown', (e)=>{
      const tag = (e.target && e.target.tagName) || '';
      if (['INPUT','TEXTAREA'].includes(tag.toUpperCase())) return;
      if (state.mode !== 'practice') return;
      const k = e.key;
      if (k === 'Enter') {
        e.preventDefault();
        if (!state.revealed) { document.getElementById('btnCheck')?.click(); }
        else { document.getElementById('inlineNext')?.click(); }
      } else if (k.toLowerCase() === 'n') {
        document.getElementById('inlineNext')?.click();
      } else if (k.toLowerCase() === 'h') {
        document.getElementById('btnHint')?.click();
      } else if (k.toLowerCase() === 's') {
        nextCard(1);
      } else if (k.toLowerCase() === 'f') {
        document.getElementById('btnFilters')?.click();
      }
    });
    $('#mbCheck')?.addEventListener('click', ()=> document.getElementById('btnCheck')?.click());
    $('#mbNext')?.addEventListener('click', ()=> document.getElementById('inlineNext')?.click() || nextCard(1));
    $('#mbHint')?.addEventListener('click', ()=> document.getElementById('btnHint')?.click());
    if (state.admin){
      $('#adminBadge').classList.remove('hidden');
      $('#adminPanel').classList.remove('hidden');
      $('#dataUrl').value = getParam('sheet') || '';
      $('#btnLoadUrl').onclick = async ()=>{
        const u = $('#dataUrl').value.trim(); if (!u) return;
        const d = await loadCsvUrl(u); state.rows = d.map(coerceRow);
        applyFilters(); rebuildDeck(); render();
      };
      $('#btnShareable').onclick = ()=>{
        const u = $('#dataUrl').value.trim(); if (!u) return alert('Enter a URL first.');
        const link = location.origin + location.pathname + `?sheet=${encodeURIComponent(u)}`;
        navigator.clipboard?.writeText(link); alert('Copied: '+link);
      };
      $('#btnExportMisses').onclick = ()=>{
        const misses = state.history.filter(h=>!h.ok);
        const lines = ["RuleCategory,Trigger,Base,Expected,Got,When"];
        for (const m of misses){
          const [cat,trig,base] = m.key.split(':');
          lines.push([cat,trig,base,m.expected,m.got,new Date(m.t).toISOString()].map(s=>`\"${(s||'').replaceAll('\"','\"\"')}\"`).join(','));
        }
        download(lines.join('\n'), 'mutation-trainer-misses.csv', 'text/csv');
      };
      $('#fileCsv').onchange = (e)=>{
        const f = e.target.files?.[0]; if (!f) return;
        Papa.parse(f, { header:true, skipEmptyLines:true, complete:(res)=>{ state.rows = res.data.map(coerceRow); applyFilters(); rebuildDeck(); render(); } });
      };
    }
    if (getParam('preset')==='prepositions'){
      state.categories=['Preposition']; saveLS('wm_categories',state.categories);
    }
  }


  
  // ---------- Boot ----------
  (async function(){
    wireUi();
    await initData();
  })();
  </script>
</body>
</html>


