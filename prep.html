<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Which preposition? / Pa arddodiad?</title>
   <link rel="stylesheet" href="styles.css" />
   <!-- Shared navbar loader -->
  <script src="./navbar.js" defer></script>

  <!-- Fonts (match index.html) -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Inconsolata:wght@200;300&family=Josefin+Sans:wght@300;400&family=Karla:wght@200;300;500;600&family=Merriweather:ital,wght@1,900&family=Poppins:ital,wght@0,100;0,200;0,400;1,100&family=Slabo+13px&family=Slabo+27px&family=Ultra&family=Yeseva+One&display=swap');

    html {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body { -webkit-font-smoothing: antialiased; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1 id="appTitle">Which preposition? / Pa arddodiad?</h1>
        <p id="appSubtitle">Prototype • Step 1: pick the preposition • Step 2 (optional): pick the pronoun form</p>
      </div>
      <div class="controls">
        <span class="pill" id="modePill">Mode: <strong id="modeLabel">Prep</strong></span>
        <button class="btn ghost" id="toggleLang" title="Toggle language">
          EN ↔ CY
        </button>
        <button class="btn primary" id="newQuestion">New question</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="filters">
          <div>
            <label id="lblLevel" for="fLevel">Level</label>
            <select id="fLevel"></select>
          </div>
          <div>
            <label id="lblMode" for="fMode">Mode</label>
            <select id="fMode"></select>
          </div>
          <div>
            <label id="lblTopic" for="fTopic">Topic</label>
            <select id="fTopic"></select>
          </div>
          <div>
            <label id="lblContrast" for="fContrast">Contrast set</label>
            <select id="fContrast"></select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="question">
          <div class="qmeta">
            <div class="left">
              <span class="pill" id="pillLevel">Level: —</span>
              <span class="pill" id="pillTopic">Topic: —</span>
              <span class="pill" id="pillContrast">Set: —</span>
            </div>
            <div class="left">
              <button class="btn" id="btnHint">Hint</button>
              <button class="btn" id="btnReveal">Reveal</button>
            </div>
          </div>

          <div class="sentence" id="sentence"></div>
          <p class="hint" id="hint"></p>

          <div>
            <div class="pill" id="stepPill">Step 1 of 2</div>
          </div>

          <div class="choices" id="choices"></div>

          <div class="feedback" id="feedback">
            <div class="headline" id="fbHeadline">—</div>
            <div id="fbBody"></div>
          </div>
        </div>
      </section>

      <aside class="rightcol">
        <section class="card">
          <div class="stats">
            <div class="stat">
              <div class="k" id="kScore">Score</div>
              <div class="v" id="vScore">0</div>
            </div>
            <div class="stat">
              <div class="k" id="kStreak">Streak</div>
              <div class="v" id="vStreak">0</div>
            </div>
            <div class="stat">
              <div class="k" id="kDone">Done</div>
              <div class="v" id="vDone">0</div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="small" id="helpText">
            <div><span class="kbd">Hint</span> shows a nudge (doesn’t affect score).</div>
            <div><span class="kbd">Reveal</span> shows the answer and explanation.</div>
            <div style="margin-top:8px;">Tip: use filters to drill one contrast set (e.g. <span class="kbd">at vs i</span>).</div>
          </div>
        </section>

        <section class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <strong id="bankTitle">Test data</strong>
            <button class="btn" id="reset">Reset</button>
          </div>
          <p class="small" id="bankInfo">
            This is a minimal test bank (a handful of contexts) — you’ll grow it into a big CSV later.
          </p>
          <div class="divider"></div>
          <div class="small" id="debug"></div>
        </section>
      </aside>
    </div>
  </div>

  <script>
    /*********************
     * Test data (what your CSV will become)
     *
     * We’re using BEFORE + AFTER fields for the gap.
     * Each item is a context sentence (you’ll have many items per preposition).
     *********************/

    const ITEMS = [
      {
        item_id: "Q0001",
        level: 1,
        mode: "prep",
        topic: { en: "Letters", cy: "Llythyrau" },
        pattern: { en: "Send to (person)", cy: "Danfon at (person)" },
        contrast_group: "AT_vs_I",
        before: { en: "Send a letter ", cy: "Danfon lythyr " },
        after: { en: " Sioned.", cy: " Sioned." },
        answer_prep: "at",
        needs_step2: 0,
        pronoun_key: "",
        answer_form: { en: "", cy: "" },
        hint: { en: "Person, not a place.", cy: "Person, nid lle." },
        why: {
          en: "In this pattern, Welsh often uses <strong>at</strong> with a person (like ‘to someone’).",
          cy: "Yn y patrwm yma, mae’r Gymraeg yn aml yn defnyddio <strong>at</strong> gyda pherson (fel ‘at rywun’)."
        },
        rule: {
          en: "<strong>at</strong> is common for ‘to (a person)’; <strong>i</strong> is common for ‘to/into (a place)’.",
          cy: "Mae <strong>at</strong> yn gyffredin am ‘at berson’; mae <strong>i</strong> yn gyffredin am ‘i / i mewn i le’."
        },
        register: "neutral",
        dialect: "Both"
      },
      {
        item_id: "Q0002",
        level: 1,
        mode: "prep",
        topic: { en: "Travel", cy: "Teithio" },
        pattern: { en: "Send to (place)", cy: "Danfon i (place)" },
        contrast_group: "AT_vs_I",
        before: { en: "Send a letter ", cy: "Danfon lythyr " },
        after: { en: " London.", cy: " Lundain." },
        answer_prep: "i",
        needs_step2: 0,
        pronoun_key: "",
        answer_form: { en: "", cy: "" },
        hint: { en: "Destination is a place.", cy: "Cyrchfan = lle." },
        why: {
          en: "Here the destination is a place you go/send <em>into</em> — <strong>i</strong>.",
          cy: "Yma lle yw’r gyrchfan (mynd/danfon <em>i mewn</em>) — <strong>i</strong>."
        },
        rule: {
          en: "Place/destination → often <strong>i</strong>.",
          cy: "Lle/cyrchfan → yn aml <strong>i</strong>."
        },
        register: "neutral",
        dialect: "Both"
      },
      {
        item_id: "Q0003",
        level: 2,
        mode: "prep",
        topic: { en: "Appointments", cy: "Apwyntiadau" },
        pattern: { en: "Go to (doctor)", cy: "Mynd at y meddyg" },
        contrast_group: "AT_vs_I",
        before: { en: "I’m going ", cy: "Dw i’n mynd " },
        after: { en: " the doctor.", cy: " at y meddyg." },
        answer_prep: "at",
        needs_step2: 0,
        pronoun_key: "",
        answer_form: { en: "", cy: "" },
        hint: { en: "You’re going to a person/appointment.", cy: "Rwyt ti’n mynd at berson/apwyntiad." },
        why: {
          en: "With professions/people as the target, <strong>at</strong> is very common.",
          cy: "Gyda pherson (neu broffesiwn) fel targed, mae <strong>at</strong> yn gyffredin iawn."
        },
        rule: {
          en: "To a person → often <strong>at</strong>.",
          cy: "At berson → yn aml <strong>at</strong>."
        },
        register: "neutral",
        dialect: "S"
      },
      {
        item_id: "Q0101",
        level: 2,
        mode: "prep",
        topic: { en: "Events", cy: "Digwyddiadau" },
        pattern: { en: "Before (time)", cy: "Cyn (amser)" },
        contrast_group: "CYN_vs_O_FLAEN",
        before: { en: "I’ll see you ", cy: "Bydda i’n dy weld di " },
        after: { en: " the concert.", cy: " cyn y cyngerdd." },
        answer_prep: "cyn",
        needs_step2: 0,
        pronoun_key: "",
        answer_form: { en: "", cy: "" },
        hint: { en: "Time, not location.", cy: "Amser, nid lle." },
        why: {
          en: "<strong>cyn</strong> is ‘before’ in time.",
          cy: "<strong>cyn</strong> = ‘cyn’ o ran amser."
        },
        rule: {
          en: "Time ‘before’ → <strong>cyn</strong>. Place ‘in front of’ → <strong>o flaen</strong>.",
          cy: "‘Cyn’ (amser) → <strong>cyn</strong>. ‘O flaen’ (lle) → <strong>o flaen</strong>."
        },
        register: "neutral",
        dialect: "Both"
      },
      {
        item_id: "Q0102",
        level: 2,
        mode: "prep",
        topic: { en: "Directions", cy: "Cyfeiriadau" },
        pattern: { en: "In front of (place)", cy: "O flaen (lle)" },
        contrast_group: "CYN_vs_O_FLAEN",
        before: { en: "Park ", cy: "Parcia " },
        after: { en: " the house.", cy: " o flaen y tŷ." },
        answer_prep: "o flaen",
        needs_step2: 0,
        pronoun_key: "",
        answer_form: { en: "", cy: "" },
        hint: { en: "Position in space.", cy: "Safle/lleoliad." },
        why: {
          en: "<strong>o flaen</strong> is ‘in front of’ (place).",
          cy: "<strong>o flaen</strong> = ‘o flaen’ (lleoliad)."
        },
        rule: {
          en: "Place ‘in front of’ → <strong>o flaen</strong>.",
          cy: "‘O flaen’ (lle) → <strong>o flaen</strong>."
        },
        register: "neutral",
        dialect: "Both"
      },
      {
        item_id: "Q0201",
        level: 2,
        mode: "prep+pronoun",
        topic: { en: "Chat", cy: "Sgwrsio" },
        pattern: { en: "Talk to (me)", cy: "Siarad â fi" },
        contrast_group: "A_vs_GYDA",
        before: { en: "She’s talking ", cy: "Mae hi’n siarad " },
        after: { en: " me.", cy: " â fi." },
        answer_prep: "â",
        needs_step2: 1,
        pronoun_key: "1S",
        answer_form: { en: "to me", cy: "â fi" },
        hint: { en: "This one stays ‘prep + pronoun’.", cy: "Mae hwn yn aros fel ‘arddodiad + rhagenw’." },
        why: {
          en: "After <strong>â</strong>, you simply use the pronoun: <strong>â fi</strong>.",
          cy: "Ar ôl <strong>â</strong>, defnyddia’r rhagenw: <strong>â fi</strong>."
        },
        rule: {
          en: "Some prepositions don’t inflect: prep + pronoun (e.g. â fi, gyda fi).",
          cy: "Dydy rhai arddodiaid ddim yn cyflyru: arddodiad + rhagenw (e.e. â fi, gyda fi)."
        },
        register: "neutral",
        dialect: "Both"
      },
      {
        item_id: "Q0202",
        level: 3,
        mode: "prep+pronoun",
        topic: { en: "Feelings", cy: "Teimladau" },
        pattern: { en: "Angry with (me)", cy: "Dig gyda fi" },
        contrast_group: "GYDA_vs_AR",
        before: { en: "He’s angry ", cy: "Mae e’n ddig " },
        after: { en: " me.", cy: " gyda fi." },
        answer_prep: "gyda",
        needs_step2: 1,
        pronoun_key: "1S",
        answer_form: { en: "with me", cy: "gyda fi" },
        hint: { en: "This pattern uses ‘with’, not ‘on’.", cy: "Mae’r patrwm yma’n defnyddio ‘gyda’, nid ‘ar’." },
        why: {
          en: "This expression uses <strong>gyda</strong> + pronoun: <strong>gyda fi</strong>.",
          cy: "Mae’r ymadrodd yma’n defnyddio <strong>gyda</strong> + rhagenw: <strong>gyda fi</strong>."
        },
        rule: {
          en: "Don’t translate word-for-word — learn the pattern: ‘angry with’ → gyda.",
          cy: "Paid â chyfieithu gair am air — dysga’r patrwm: ‘dig gyda’ → gyda."
        },
        register: "neutral",
        dialect: "Both"
      },
      {
        item_id: "Q0301",
        level: 3,
        mode: "prep+pronoun",
        topic: { en: "Ownership", cy: "Perchnogaeth" },
        pattern: { en: "On me (inflected)", cy: "Arna i (cyfunol)" },
        contrast_group: "INFLECTED_AR",
        before: { en: "It’s ", cy: "Mae e " },
        after: { en: " me.", cy: " arna i." },
        answer_prep: "ar",
        needs_step2: 1,
        pronoun_key: "1S",
        answer_form: { en: "on me", cy: "arna i" },
        hint: { en: "This one inflects (it changes).", cy: "Mae hwn yn cyflyru (mae’n newid)." },
        why: {
          en: "<strong>ar</strong> is an inflected preposition with pronouns: <strong>arna i</strong> (not *ar fi*).",
          cy: "Mae <strong>ar</strong> yn arddodiad cyfunol gyda rhagenwau: <strong>arna i</strong> (nid *ar fi*)."
        },
        rule: {
          en: "Some prepositions inflect with pronouns: arna i, arnat ti, arno fe, arni hi…",
          cy: "Mae rhai arddodiaid yn cyflyru gyda rhagenwau: arna i, arnat ti, arno fe, arni hi…"
        },
        register: "neutral",
        dialect: "Both"
      }
    ];

    /*********************
     * Choice sets (distractors)
     * You can tune these later.
     *********************/
    const CHOICE_SETS = {
      AT_vs_I: ["at", "i", "o", "gyda"],
      CYN_vs_O_FLAEN: ["cyn", "o flaen", "ar ôl", "wrth"],
      A_vs_GYDA: ["â", "gyda", "at", "i"],
      GYDA_vs_AR: ["gyda", "ar", "â", "at"],
      INFLECTED_AR: ["ar", "gyda", "â", "at"]
    };

    /*********************
     * Pronoun labels (for Step 2 UI)
     *********************/
    const PRONOUNS = {
      "1S": { en: "me", cy: "fi / i" },
      "2S": { en: "you (sing.)", cy: "ti" },
      "3SM": { en: "him", cy: "fe/fo" },
      "3SF": { en: "her", cy: "hi" },
      "1PL": { en: "us", cy: "ni" },
      "2PL": { en: "you (pl.)", cy: "chi" },
      "3PL": { en: "them", cy: "nhw" }
    };

    // Minimal pronoun-form bank for Step 2 distractors
    // (Kept tiny for the prototype; you can expand later.)
    const PREP_FORMS = {
      "ar": {
        type: "inflected",
        forms_cy: {
          "1S": "arna i",
          "2S": "arnat ti",
          "3SM": "arno fe",
          "3SF": "arni hi",
          "1PL": "arnon ni",
          "2PL": "arnoch chi",
          "3PL": "arnyn nhw"
        }
      },
      "at": {
        type: "inflected",
        forms_cy: {
          "1S": "ata i",
          "2S": "atat ti",
          "3SM": "ato fe",
          "3SF": "ati hi",
          "1PL": "aton ni",
          "2PL": "atoch chi",
          "3PL": "atyn nhw"
        }
      },
      "i": {
        type: "mixed",
        // Many learners also use i + pronoun; we still give some inflected-ish options as distractors.
        forms_cy: {
          "1S": "imi / i mi",
          "2S": "iti / i ti",
          "3SM": "iddo fe",
          "3SF": "iddi hi",
          "1PL": "inni / i ni",
          "2PL": "ichwi / i chi",
          "3PL": "iddyn nhw"
        }
      },
      "gyda": {
        type: "noninflecting",
        forms_cy: {
          "1S": "gyda fi",
          "2S": "gyda ti",
          "3SM": "gyda fe",
          "3SF": "gyda hi",
          "1PL": "gyda ni",
          "2PL": "gyda chi",
          "3PL": "gyda nhw"
        }
      },
      "â": {
        type: "noninflecting",
        forms_cy: {
          "1S": "â fi",
          "2S": "â ti",
          "3SM": "ag e",
          "3SF": "â hi",
          "1PL": "â ni",
          "2PL": "â chi",
          "3PL": "â nhw"
        }
      }
    };

    /*********************
     * App state
     *********************/
    const state = {
      lang: (localStorage.getItem("wpt_lang") || "en"), // en | cy
      score: 0,
      streak: 0,
      done: 0,
      used: new Set(),
      current: null,
      step: 1,
      step1Chosen: null,
      locked: false
    };

    /*********************
     * DOM helpers
     *********************/
    const $ = (id) => document.getElementById(id);

    const els = {
      toggleLang: $("toggleLang"),
      newQuestion: $("newQuestion"),
      sentence: $("sentence"),
      choices: $("choices"),
      feedback: $("feedback"),
      fbHeadline: $("fbHeadline"),
      fbBody: $("fbBody"),
      hint: $("hint"),
      btnHint: $("btnHint"),
      btnReveal: $("btnReveal"),
      stepPill: $("stepPill"),
      modeLabel: $("modeLabel"),
      modePill: $("modePill"),
      vScore: $("vScore"),
      vStreak: $("vStreak"),
      vDone: $("vDone"),
      reset: $("reset"),
      debug: $("debug"),

      // filters
      fLevel: $("fLevel"),
      fMode: $("fMode"),
      fTopic: $("fTopic"),
      fContrast: $("fContrast"),

      // pills
      pillLevel: $("pillLevel"),
      pillTopic: $("pillTopic"),
      pillContrast: $("pillContrast"),

      // labels
      lblLevel: $("lblLevel"),
      lblMode: $("lblMode"),
      lblTopic: $("lblTopic"),
      lblContrast: $("lblContrast"),

      // copy
      appSubtitle: $("appSubtitle"),
      helpText: $("helpText"),
      bankTitle: $("bankTitle"),
      bankInfo: $("bankInfo"),
      kScore: $("kScore"),
      kStreak: $("kStreak"),
      kDone: $("kDone")
    };

    function t(en, cy) {
      return state.lang === "cy" ? cy : en;
    }

    function setLanguage(lang) {
      state.lang = lang;
      localStorage.setItem("wpt_lang", lang);
      renderStaticText();
      renderFilters();
      if (state.current) renderQuestion();
    }

    function renderStaticText() {
      els.appSubtitle.textContent = t(
        "Prototype • Step 1: pick the preposition • Step 2 (optional): pick the pronoun form",
        "Prototeip • Cam 1: dewis yr arddodiad • Cam 2 (dewisol): dewis y ffurf gyda rhagenw"
      );
      els.lblLevel.textContent = t("Level", "Lefel");
      els.lblMode.textContent = t("Mode", "Modd");
      els.lblTopic.textContent = t("Topic", "Pwnc");
      els.lblContrast.textContent = t("Contrast set", "Set cyferbyniad");

      els.kScore.textContent = t("Score", "Sgôr");
      els.kStreak.textContent = t("Streak", "Rhediad");
      els.kDone.textContent = t("Done", "Wedi gwneud");

      els.btnHint.textContent = t("Hint", "Awgrym");
      els.btnReveal.textContent = t("Reveal", "Dangos");
      els.newQuestion.textContent = t("New question", "Cwestiwn newydd");
      els.reset.textContent = t("Reset", "Ailosod");
      els.bankTitle.textContent = t("Test data", "Data prawf");
      els.bankInfo.textContent = t(
        "This is a minimal test bank (a handful of contexts) — you’ll grow it into a big CSV later.",
        "Banc prawf bach yw hwn (llond llaw o gyd-destunau) — byddi di’n ei dyfu’n CSV mawr yn nes ymlaen."
      );
      els.helpText.innerHTML = t(
        "<div><span class='kbd'>Hint</span> shows a nudge (doesn’t affect score).</div><div><span class='kbd'>Reveal</span> shows the answer and explanation.</div><div style='margin-top:8px;'>Tip: use filters to drill one contrast set (e.g. <span class='kbd'>at vs i</span>).</div>",
        "<div><span class='kbd'>Awgrym</span> yn dangos cliw (dim effaith ar y sgôr).</div><div><span class='kbd'>Dangos</span> yn dangos yr ateb a’r esboniad.</div><div style='margin-top:8px;'>Awgrym: defnyddia hidlwyr i ymarfer un set cyferbyniad (e.e. <span class='kbd'>at vs i</span>).</div>"
      );
    }

    function uniq(arr) {
      return Array.from(new Set(arr)).filter(v => v !== undefined && v !== null);
    }

    function renderFilters() {
      const levels = uniq(ITEMS.map(i => i.level)).sort((a,b)=>a-b);
      const modes = uniq(ITEMS.map(i => i.mode));
      const topics = uniq(ITEMS.map(i => state.lang === "cy" ? i.topic.cy : i.topic.en)).sort((a,b)=>a.localeCompare(b));
      const contrasts = uniq(ITEMS.map(i => i.contrast_group)).sort((a,b)=>a.localeCompare(b));

      fillSelect(els.fLevel, [t("All", "Pob un"), ...levels.map(String)], "All");
      fillSelect(els.fMode, [t("All", "Pob un"), ...modes], "All");
      fillSelect(els.fTopic, [t("All", "Pob un"), ...topics], "All");
      fillSelect(els.fContrast, [t("All", "Pob un"), ...contrasts], "All");
    }

    function fillSelect(sel, options, allLabelEn) {
      const current = sel.value;
      sel.innerHTML = "";
      for (const opt of options) {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        sel.appendChild(o);
      }
      // try preserve
      if (options.includes(current)) sel.value = current;
      else sel.value = options[0];
    }

    function getFilteredItems() {
      const lvl = els.fLevel.value;
      const mode = els.fMode.value;
      const topic = els.fTopic.value;
      const contrast = els.fContrast.value;

      return ITEMS.filter(i => {
        if (lvl !== t("All","Pob un") && String(i.level) !== lvl) return false;
        if (mode !== t("All","Pob un") && i.mode !== mode) return false;
        const topicLabel = state.lang === "cy" ? i.topic.cy : i.topic.en;
        if (topic !== t("All","Pob un") && topicLabel !== topic) return false;
        if (contrast !== t("All","Pob un") && i.contrast_group !== contrast) return false;
        return true;
      });
    }

    function pickNextItem() {
      const pool = getFilteredItems();
      if (pool.length === 0) return null;

      // avoid repeats until pool exhausted
      const unused = pool.filter(i => !state.used.has(i.item_id));
      const list = unused.length ? unused : pool;
      if (!unused.length) state.used.clear();

      const item = list[Math.floor(Math.random() * list.length)];
      state.used.add(item.item_id);
      return item;
    }

    function renderQuestion() {
      const item = state.current;
      if (!item) return;

      state.step = 1;
      state.step1Chosen = null;
      state.locked = false;

      els.feedback.style.display = "none";
      els.hint.style.display = "none";

      const before = state.lang === "cy" ? item.before.cy : item.before.en;
      const after = state.lang === "cy" ? item.after.cy : item.after.en;
      els.sentence.innerHTML = `${escapeHtml(before)}<span class="gap" id="gap">__</span>${escapeHtml(after)}`;

      els.pillLevel.textContent = t("Level", "Lefel") + ": " + item.level;
      els.pillTopic.textContent = t("Topic", "Pwnc") + ": " + (state.lang === "cy" ? item.topic.cy : item.topic.en);
      els.pillContrast.textContent = t("Set", "Set") + ": " + prettyContrast(item.contrast_group);

      els.modeLabel.textContent = item.mode;
      els.modePill.innerHTML = `${t("Mode", "Modd")}: <strong id="modeLabel">${item.mode}</strong>`;

      els.hint.innerHTML = state.lang === "cy" ? item.hint.cy : item.hint.en;

      els.stepPill.textContent = item.needs_step2 ? t("Step 1 of 2", "Cam 1 o 2") : t("Step 1 of 1", "Cam 1 o 1");

      renderStep1Choices(item);
      renderDebug(item);
    }

    function renderStep1Choices(item) {
      const set = CHOICE_SETS[item.contrast_group] || [item.answer_prep, "i", "at", "ar"]; // fallback
      const choices = uniq(set);
      shuffleInPlace(choices);

      els.choices.innerHTML = "";
      for (const ch of choices) {
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = ch;
        b.onclick = () => onPickPrep(ch);
        els.choices.appendChild(b);
      }

      // keyboard shortcuts 1-4
      window.onkeydown = (e) => {
        if (state.locked) return;
        const n = parseInt(e.key, 10);
        if (n >= 1 && n <= Math.min(4, choices.length)) {
          onPickPrep(choices[n-1]);
        }
      };
    }

    function onPickPrep(choice) {
      if (state.locked) return;
      const item = state.current;
      state.step1Chosen = choice;

      const correct = normalize(choice) === normalize(item.answer_prep);

      // show chosen in the sentence
      const gap = document.getElementById("gap");
      gap.textContent = choice;

      // lock Step 1
      state.locked = true;
      markChoiceButtons(item.answer_prep);

      if (!correct) {
        state.done += 1;
        state.streak = 0;
        showFeedback(false, item, {
          headline: t("Not quite", "Dim yn hollol"),
          body: `${t("Correct preposition:", "Arddodiad cywir:")} <strong>${item.answer_prep}</strong>.`
        });
        updateStats();
        return;
      }

      // Step 1 correct
      if (item.needs_step2) {
        // move to Step 2
        state.step = 2;
        state.locked = false;
        els.stepPill.textContent = t("Step 2 of 2", "Cam 2 o 2");
        renderStep2Choices(item);
        showFeedback(true, item, {
          headline: t("Good — now the pronoun form", "Da — nawr y ffurf rhagenw"),
          body: t(
            `You picked <strong>${item.answer_prep}</strong>. Now choose the correct form for <strong>${PRONOUNS[item.pronoun_key].en}</strong>.`,
            `Dewisaist ti <strong>${item.answer_prep}</strong>. Nawr dewis y ffurf gywir ar gyfer <strong>${PRONOUNS[item.pronoun_key].cy}</strong>.`
          )
        }, { briefOnly: true });
      } else {
        state.done += 1;
        state.streak += 1;
        state.score += 1;
        showFullExplanation(true, item);
        updateStats();
      }
    }

    function renderStep2Choices(item) {
      const prep = item.answer_prep;
      const pronKey = item.pronoun_key;

      const correctCY = item.answer_form.cy;

      // Build distractors
      const options = new Set([correctCY]);

      // 1) Wrong: base prep + an independent pronoun (for inflected/mixed preps)
      const wrongIndependent = buildIndependentForm(prep, pronKey);
      if (wrongIndependent && wrongIndependent !== correctCY) options.add(wrongIndependent);

      // 2) Wrong: same prep but different pronoun
      const bank = PREP_FORMS[prep]?.forms_cy || {};
      const otherKeys = Object.keys(bank).filter(k => k !== pronKey);
      if (otherKeys.length) {
        const k = otherKeys[Math.floor(Math.random() * otherKeys.length)];
        options.add(bank[k]);
      }

      // 3) Wrong: another prep's correct form for same pronoun
      const otherPreps = Object.keys(PREP_FORMS).filter(p => p !== prep);
      if (otherPreps.length) {
        const p = otherPreps[Math.floor(Math.random() * otherPreps.length)];
        const form = PREP_FORMS[p]?.forms_cy?.[pronKey];
        if (form) options.add(form);
      }

      // Ensure 4 options if possible
      while (options.size < 4) {
        const p = Object.keys(PREP_FORMS)[Math.floor(Math.random() * Object.keys(PREP_FORMS).length)];
        const keys = Object.keys(PREP_FORMS[p].forms_cy);
        const k = keys[Math.floor(Math.random() * keys.length)];
        options.add(PREP_FORMS[p].forms_cy[k]);
      }

      const list = Array.from(options).slice(0, 4);
      shuffleInPlace(list);

      els.choices.innerHTML = "";
      for (const ch of list) {
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = ch;
        b.onclick = () => onPickForm(ch);
        els.choices.appendChild(b);
      }

      window.onkeydown = (e) => {
        if (state.locked) return;
        const n = parseInt(e.key, 10);
        if (n >= 1 && n <= Math.min(4, list.length)) {
          onPickForm(list[n-1]);
        }
      };
    }

    function onPickForm(choiceCY) {
      if (state.locked) return;
      const item = state.current;
      state.locked = true;

      // Replace the sentence gap with Step 1 prep (already) and show a small note
      // (We keep the sentence display as-is; Step 2 is about form selection.)

      const correct = normalize(choiceCY) === normalize(item.answer_form.cy);

      markChoiceButtons(item.answer_form.cy, { step2: true });

      state.done += 1;
      if (correct) {
        state.score += 1;
        state.streak += 1;
      } else {
        state.streak = 0;
      }

      showFullExplanation(correct, item, { chosenForm: choiceCY });
      updateStats();
    }

    function showFullExplanation(correct, item, extra = {}) {
      const why = state.lang === "cy" ? item.why.cy : item.why.en;
      const rule = state.lang === "cy" ? item.rule.cy : item.rule.en;

      let answerLine = "";
      if (item.needs_step2) {
        answerLine = t(
          `Answer: <strong>${item.answer_prep}</strong> → <strong>${item.answer_form.cy}</strong>.`,
          `Ateb: <strong>${item.answer_prep}</strong> → <strong>${item.answer_form.cy}</strong>.`
        );
      } else {
        answerLine = t(
          `Answer: <strong>${item.answer_prep}</strong>.`,
          `Ateb: <strong>${item.answer_prep}</strong>.`
        );
      }

      const chosenForm = extra.chosenForm ? `<div class="small" style="margin-top:8px;">${t("You chose:", "Dewisaist ti:")} <strong>${escapeHtml(extra.chosenForm)}</strong></div>` : "";

      showFeedback(correct, item, {
        headline: correct ? t("Correct", "Cywir") : t("Incorrect", "Anghywir"),
        body: `${answerLine}${chosenForm}<div style="margin-top:10px;">${why}</div><div class="rule" style="margin-top:8px;">${rule}</div>`
      });

      // If Step 2: also show the selected form somewhere in the sentence area as a tiny caption
      if (item.needs_step2) {
        els.sentence.insertAdjacentHTML(
          "beforeend",
          `<div class="small" style="margin-top:10px; color: var(--muted);">${t("Step 2 chosen form:", "Cam 2 – ffurf a ddewiswyd:")} <strong>${escapeHtml(extra.chosenForm || item.answer_form.cy)}</strong></div>`
        );
      }
    }

    function showFeedback(correct, item, { headline, body }, opts = {}) {
      els.feedback.className = "feedback " + (correct ? "good" : "bad");
      els.feedback.style.display = "block";
      els.fbHeadline.textContent = headline;
      if (opts.briefOnly) {
        els.fbBody.innerHTML = body;
      } else {
        els.fbBody.innerHTML = body;
      }
    }

    function markChoiceButtons(correctValue, opts = {}) {
      const buttons = Array.from(els.choices.querySelectorAll("button"));
      for (const b of buttons) {
        const val = b.textContent;
        if (!opts.step2) {
          if (normalize(val) === normalize(correctValue)) b.classList.add("good");
          else if (state.step1Chosen && normalize(val) === normalize(state.step1Chosen) && normalize(val) !== normalize(correctValue)) b.classList.add("bad");
          b.disabled = true;
        } else {
          // step2: correctValue is the correct CY form
          if (normalize(val) === normalize(correctValue)) b.classList.add("good");
          else if (normalize(val) === normalize(state.step1Chosen)) { /* ignore */ }
          b.disabled = true;
        }
      }
    }

    function buildIndependentForm(prep, pronKey) {
      // For prototype only. In reality you might store a proper independent-pronoun table.
      const indep = {
        "1S": "fi",
        "2S": "ti",
        "3SM": "fe",
        "3SF": "hi",
        "1PL": "ni",
        "2PL": "chi",
        "3PL": "nhw"
      };
      const p = prep;
      const pro = indep[pronKey];
      if (!pro) return null;
      return `${p} ${pro}`;
    }

    function updateStats() {
      els.vScore.textContent = String(state.score);
      els.vStreak.textContent = String(state.streak);
      els.vDone.textContent = String(state.done);
    }

    function prettyContrast(code) {
      // nicer display
      return code.replaceAll("_", " ").replaceAll("vs", "vs");
    }

    function renderDebug(item) {
      const lines = [
        `${t("Current item", "Eitem gyfredol")}: <strong>${item.item_id}</strong>`,
        `${t("Pattern", "Patrwm")}: ${escapeHtml(state.lang === "cy" ? item.pattern.cy : item.pattern.en)}`,
        `${t("Answer", "Ateb")}: <strong>${escapeHtml(item.answer_prep)}</strong>${item.needs_step2 ? ` → <strong>${escapeHtml(item.answer_form.cy)}</strong>` : ""}`
      ];
      els.debug.innerHTML = lines.map(l => `<div class="small">${l}</div>`).join("");
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normalize(s) {
      return String(s).trim().toLowerCase().replace(/\s+/g, " ");
    }

    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function revealAnswer() {
      const item = state.current;
      if (!item) return;

      // fill the gap with the correct prep
      const gap = document.getElementById("gap");
      gap.textContent = item.answer_prep;

      // If step2 is required, show the full answer and explanation
      state.locked = true;
      state.done += 1;
      state.streak = 0;

      showFullExplanation(false, item, { chosenForm: item.needs_step2 ? "(revealed)" : undefined });
      updateStats();

      // Disable choice buttons
      Array.from(els.choices.querySelectorAll("button")).forEach(b => b.disabled = true);
    }

    function showHint() {
      if (!state.current) return;
      els.hint.style.display = "block";
    }

    function newQuestion() {
      const item = pickNextItem();
      if (!item) {
        els.sentence.innerHTML = `<div class="small">${t("No items match your filters.", "Does dim eitemau’n cyfateb i’r hidlwyr.")}</div>`;
        els.choices.innerHTML = "";
        els.feedback.style.display = "none";
        return;
      }
      state.current = item;
      renderQuestion();
    }

    function resetAll() {
      state.score = 0;
      state.streak = 0;
      state.done = 0;
      state.used.clear();
      updateStats();
      newQuestion();
    }

    // Events
    els.toggleLang.addEventListener("click", () => setLanguage(state.lang === "en" ? "cy" : "en"));
    els.newQuestion.addEventListener("click", newQuestion);
    els.btnHint.addEventListener("click", showHint);
    els.btnReveal.addEventListener("click", revealAnswer);
    els.reset.addEventListener("click", resetAll);

    // Filters reroll question
    [els.fLevel, els.fMode, els.fTopic, els.fContrast].forEach(sel => {
      sel.addEventListener("change", () => {
        state.used.clear();
        newQuestion();
      });
    });

    // Init
    renderStaticText();
    renderFilters();
    updateStats();
    newQuestion();
  </script>
</body>
</html>
